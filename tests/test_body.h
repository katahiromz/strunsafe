#define BUFSIZE 8
#define FILL_BUFFER(buf) do { \
    size_t i; \
    for (i = 0; i < BUFSIZE; ++i) { \
        buf[i] = 'F'; \
    } \
} while (0)
#define SET_FIRST(buf) buf[0] = 0
#define SET_MIDDLE(buf) buf[BUFSIZE / 2] = 0
#define SET_LAST(buf) buf[BUFSIZE - 1] = 0
#define INVALID_LENGTH ((size_t)STRSAFE_MAX_CCH + 1)

START_TEST(StringCchCopyA)
{
    char buf[BUFSIZE];
    HRESULT hr;

    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyA(buf, INVALID_LENGTH, "a");
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    //mtest_psz_eq(buf, "FFFFFFF"); // can be ''

    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyA(buf, 0, "");
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_psz_eq(buf, "FFFFFFF");
    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyA(buf, 1, "");
    mtest_long_eq(hr, S_OK);
    mtest_psz_eq(buf, "");
    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyA(buf, 2, "");
    mtest_long_eq(hr, S_OK);
    mtest_psz_eq(buf, "");
    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyA(buf, 3, "");
    mtest_long_eq(hr, S_OK);
    mtest_psz_eq(buf, "");
    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyA(buf, 4, "");
    mtest_long_eq(hr, S_OK);
    mtest_psz_eq(buf, "");

    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyA(buf, 0, "a");
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_psz_eq(buf, "FFFFFFF");
    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyA(buf, 1, "a");
    mtest_long_eq(hr, STRSAFE_E_INSUFFICIENT_BUFFER);
    mtest_psz_eq(buf, "");
    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyA(buf, 2, "a");
    mtest_long_eq(hr, S_OK);
    mtest_psz_eq(buf, "a");
    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyA(buf, 3, "a");
    mtest_long_eq(hr, S_OK);
    mtest_psz_eq(buf, "a");
    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyA(buf, 4, "a");
    mtest_long_eq(hr, S_OK);
    mtest_psz_eq(buf, "a");

    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyA(buf, 0, "ab");
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_psz_eq(buf, "FFFFFFF");
    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyA(buf, 1, "ab");
    mtest_long_eq(hr, STRSAFE_E_INSUFFICIENT_BUFFER);
    mtest_psz_eq(buf, "");
    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyA(buf, 2, "ab");
    mtest_long_eq(hr, STRSAFE_E_INSUFFICIENT_BUFFER);
    mtest_psz_eq(buf, "a");
    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyA(buf, 3, "ab");
    mtest_long_eq(hr, S_OK);
    mtest_psz_eq(buf, "ab");
    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyA(buf, 4, "ab");
    mtest_long_eq(hr, S_OK);
    mtest_psz_eq(buf, "ab");

    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyA(buf, 0, "abc");
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_psz_eq(buf, "FFFFFFF");
    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyA(buf, 1, "abc");
    mtest_long_eq(hr, STRSAFE_E_INSUFFICIENT_BUFFER);
    mtest_psz_eq(buf, "");
    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyA(buf, 2, "abc");
    mtest_long_eq(hr, STRSAFE_E_INSUFFICIENT_BUFFER);
    mtest_psz_eq(buf, "a");
    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyA(buf, 3, "abc");
    mtest_long_eq(hr, STRSAFE_E_INSUFFICIENT_BUFFER);
    mtest_psz_eq(buf, "ab");
    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyA(buf, 4, "abc");
    mtest_long_eq(hr, S_OK);
    mtest_psz_eq(buf, "abc");
}

START_TEST(StringCchCatA)
{
    char buf[BUFSIZE];
    HRESULT hr;

    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatA(buf, INVALID_LENGTH, "a");
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_psz_eq(buf, "");

    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatA(buf, 0, "");
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_psz_eq(buf, "");
    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatA(buf, 1, "");
    mtest_long_eq(hr, S_OK);
    mtest_psz_eq(buf, "");
    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatA(buf, 2, "");
    mtest_long_eq(hr, S_OK);
    mtest_psz_eq(buf, "");
    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatA(buf, 3, "");
    mtest_long_eq(hr, S_OK);
    mtest_psz_eq(buf, "");
    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatA(buf, 4, "");
    mtest_long_eq(hr, S_OK);
    mtest_psz_eq(buf, "");

    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatA(buf, 0, "a");
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_psz_eq(buf, "");
    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatA(buf, 1, "a");
    mtest_long_eq(hr, STRSAFE_E_INSUFFICIENT_BUFFER);
    mtest_psz_eq(buf, "");
    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatA(buf, 2, "a");
    mtest_long_eq(hr, S_OK);
    mtest_psz_eq(buf, "a");
    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatA(buf, 3, "a");
    mtest_long_eq(hr, S_OK);
    mtest_psz_eq(buf, "a");
    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatA(buf, 4, "a");
    mtest_long_eq(hr, S_OK);
    mtest_psz_eq(buf, "a");

    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatA(buf, 0, "ab");
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_psz_eq(buf, "");
    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatA(buf, 1, "ab");
    mtest_long_eq(hr, STRSAFE_E_INSUFFICIENT_BUFFER);
    mtest_psz_eq(buf, "");
    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatA(buf, 2, "ab");
    mtest_long_eq(hr, STRSAFE_E_INSUFFICIENT_BUFFER);
    mtest_psz_eq(buf, "a");
    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatA(buf, 3, "ab");
    mtest_long_eq(hr, S_OK);
    mtest_psz_eq(buf, "ab");
    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatA(buf, 4, "ab");
    mtest_long_eq(hr, S_OK);
    mtest_psz_eq(buf, "ab");

    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatA(buf, 0, "abc");
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_psz_eq(buf, "");
    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatA(buf, 1, "abc");
    mtest_long_eq(hr, STRSAFE_E_INSUFFICIENT_BUFFER);
    mtest_psz_eq(buf, "");
    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatA(buf, 2, "abc");
    mtest_long_eq(hr, STRSAFE_E_INSUFFICIENT_BUFFER);
    mtest_psz_eq(buf, "a");
    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatA(buf, 3, "abc");
    mtest_long_eq(hr, STRSAFE_E_INSUFFICIENT_BUFFER);
    mtest_psz_eq(buf, "ab");
    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatA(buf, 4, "abc");
    mtest_long_eq(hr, S_OK);
    mtest_psz_eq(buf, "abc");

    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatA(buf, 0, "");
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_psz_eq(buf, "FFFF");
    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatA(buf, 1, "");
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_psz_eq(buf, "FFFF");
    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatA(buf, 2, "");
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_psz_eq(buf, "FFFF");
    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatA(buf, 3, "");
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_psz_eq(buf, "FFFF");
    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatA(buf, 4, "");
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_psz_eq(buf, "FFFF");

    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatA(buf, 0, "a");
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_psz_eq(buf, "FFFF");
    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatA(buf, 1, "a");
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_psz_eq(buf, "FFFF");
    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatA(buf, 2, "a");
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_psz_eq(buf, "FFFF");
    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatA(buf, 3, "a");
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_psz_eq(buf, "FFFF");
    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatA(buf, 4, "a");
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_psz_eq(buf, "FFFF");

    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatA(buf, 0, "ab");
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_psz_eq(buf, "FFFF");
    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatA(buf, 1, "ab");
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_psz_eq(buf, "FFFF");
    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatA(buf, 2, "ab");
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_psz_eq(buf, "FFFF");
    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatA(buf, 3, "ab");
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_psz_eq(buf, "FFFF");
    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatA(buf, 4, "ab");
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_psz_eq(buf, "FFFF");

    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatA(buf, 0, "abc");
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_psz_eq(buf, "FFFF");
    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatA(buf, 1, "abc");
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_psz_eq(buf, "FFFF");
    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatA(buf, 2, "abc");
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_psz_eq(buf, "FFFF");
    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatA(buf, 3, "abc");
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_psz_eq(buf, "FFFF");
    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatA(buf, 4, "abc");
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_psz_eq(buf, "FFFF");
}

START_TEST(StringCchCatNA)
{
    char buf[BUFSIZE];
    HRESULT hr;

    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNA(buf, INVALID_LENGTH, "a", 1);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_psz_eq(buf, "");

    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNA(buf, 1, "a", INVALID_LENGTH);
    //mtest_long_eq(hr, STRSAFE_E_INSUFFICIENT_BUFFER); // can be STRSAFE_E_INVALID_PARAMETER
    mtest_psz_eq(buf, "");

    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNA(buf, 0, "", 0);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_psz_eq(buf, "");
    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNA(buf, 1, "", 0);
    mtest_long_eq(hr, S_OK);
    mtest_psz_eq(buf, "");
    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNA(buf, 2, "", 0);
    mtest_long_eq(hr, S_OK);
    mtest_psz_eq(buf, "");
    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNA(buf, 3, "", 0);
    mtest_long_eq(hr, S_OK);
    mtest_psz_eq(buf, "");
    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNA(buf, 4, "", 0);
    mtest_long_eq(hr, S_OK);
    mtest_psz_eq(buf, "");

    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNA(buf, 0, "a", 0);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_psz_eq(buf, "");
    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNA(buf, 1, "a", 0);
    mtest_long_eq(hr, S_OK);
    mtest_psz_eq(buf, "");
    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNA(buf, 2, "a", 0);
    mtest_long_eq(hr, S_OK);
    mtest_psz_eq(buf, "");
    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNA(buf, 3, "a", 0);
    mtest_long_eq(hr, S_OK);
    mtest_psz_eq(buf, "");
    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNA(buf, 4, "a", 0);
    mtest_long_eq(hr, S_OK);
    mtest_psz_eq(buf, "");

    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNA(buf, 0, "ab", 0);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_psz_eq(buf, "");
    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNA(buf, 1, "ab", 0);
    mtest_long_eq(hr, S_OK);
    mtest_psz_eq(buf, "");
    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNA(buf, 2, "ab", 0);
    mtest_long_eq(hr, S_OK);
    mtest_psz_eq(buf, "");
    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNA(buf, 3, "ab", 0);
    mtest_long_eq(hr, S_OK);
    mtest_psz_eq(buf, "");
    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNA(buf, 4, "ab", 0);
    mtest_long_eq(hr, S_OK);
    mtest_psz_eq(buf, "");

    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNA(buf, 0, "abc", 0);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER );
    mtest_psz_eq(buf, "");
    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNA(buf, 1, "abc", 0);
    mtest_long_eq(hr, S_OK);
    mtest_psz_eq(buf, "");
    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNA(buf, 2, "abc", 0);
    mtest_long_eq(hr, S_OK);
    mtest_psz_eq(buf, "");
    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNA(buf, 3, "abc", 0);
    mtest_long_eq(hr, S_OK);
    mtest_psz_eq(buf, "");
    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNA(buf, 4, "abc", 0);
    mtest_long_eq(hr, S_OK);
    mtest_psz_eq(buf, "");

    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNA(buf, 0, "", 1);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_psz_eq(buf, "");
    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNA(buf, 1, "", 1);
    mtest_long_eq(hr, S_OK);
    mtest_psz_eq(buf, "");
    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNA(buf, 2, "", 1);
    mtest_long_eq(hr, S_OK);
    mtest_psz_eq(buf, "");
    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNA(buf, 3, "", 1);
    mtest_long_eq(hr, S_OK);
    mtest_psz_eq(buf, "");
    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNA(buf, 4, "", 1);
    mtest_long_eq(hr, S_OK);
    mtest_psz_eq(buf, "");

    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNA(buf, 0, "a", 1);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_psz_eq(buf, "");
    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNA(buf, 1, "a", 1);
    mtest_long_eq(hr, STRSAFE_E_INSUFFICIENT_BUFFER);
    mtest_psz_eq(buf, "");
    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNA(buf, 2, "a", 1);
    mtest_long_eq(hr, S_OK);
    mtest_psz_eq(buf, "a");
    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNA(buf, 3, "a", 1);
    mtest_long_eq(hr, S_OK);
    mtest_psz_eq(buf, "a");
    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNA(buf, 4, "a", 1);
    mtest_long_eq(hr, S_OK);
    mtest_psz_eq(buf, "a");

    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNA(buf, 0, "ab", 1);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_psz_eq(buf, "");
    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNA(buf, 1, "ab", 1);
    mtest_long_eq(hr, STRSAFE_E_INSUFFICIENT_BUFFER);
    mtest_psz_eq(buf, "");
    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNA(buf, 2, "ab", 1);
    mtest_long_eq(hr, S_OK);
    mtest_psz_eq(buf, "a");
    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNA(buf, 3, "ab", 1);
    mtest_long_eq(hr, S_OK);
    mtest_psz_eq(buf, "a");
    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNA(buf, 4, "ab", 1);
    mtest_long_eq(hr, S_OK);
    mtest_psz_eq(buf, "a");

    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNA(buf, 0, "abc", 1);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_psz_eq(buf, "");
    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNA(buf, 1, "abc", 1);
    mtest_long_eq(hr, STRSAFE_E_INSUFFICIENT_BUFFER);
    mtest_psz_eq(buf, "");
    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNA(buf, 2, "abc", 1);
    mtest_long_eq(hr, S_OK);
    mtest_psz_eq(buf, "a");
    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNA(buf, 3, "abc", 1);
    mtest_long_eq(hr, S_OK);
    mtest_psz_eq(buf, "a");
    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNA(buf, 4, "abc", 1);
    mtest_long_eq(hr, S_OK);
    mtest_psz_eq(buf, "a");

    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNA(buf, 0, "", 2);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_psz_eq(buf, "");
    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNA(buf, 1, "", 2);
    mtest_long_eq(hr, S_OK);
    mtest_psz_eq(buf, "");
    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNA(buf, 2, "", 2);
    mtest_long_eq(hr, S_OK);
    mtest_psz_eq(buf, "");
    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNA(buf, 3, "", 2);
    mtest_long_eq(hr, S_OK);
    mtest_psz_eq(buf, "");
    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNA(buf, 4, "", 2);
    mtest_long_eq(hr, S_OK);
    mtest_psz_eq(buf, "");

    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNA(buf, 0, "a", 2);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_psz_eq(buf, "");
    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNA(buf, 1, "a", 2);
    mtest_long_eq(hr, STRSAFE_E_INSUFFICIENT_BUFFER);
    mtest_psz_eq(buf, "");
    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNA(buf, 2, "a", 2);
    mtest_long_eq(hr, S_OK);
    mtest_psz_eq(buf, "a");
    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNA(buf, 3, "a", 2);
    mtest_long_eq(hr, S_OK);
    mtest_psz_eq(buf, "a");
    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNA(buf, 4, "a", 2);
    mtest_long_eq(hr, S_OK);
    mtest_psz_eq(buf, "a");

    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNA(buf, 0, "ab", 2);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_psz_eq(buf, "");
    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNA(buf, 1, "ab", 2);
    mtest_long_eq(hr, STRSAFE_E_INSUFFICIENT_BUFFER);
    mtest_psz_eq(buf, "");
    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNA(buf, 2, "ab", 2);
    mtest_long_eq(hr, STRSAFE_E_INSUFFICIENT_BUFFER);
    mtest_psz_eq(buf, "a");
    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNA(buf, 3, "ab", 2);
    mtest_long_eq(hr, S_OK);
    mtest_psz_eq(buf, "ab");
    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNA(buf, 4, "ab", 2);
    mtest_long_eq(hr, S_OK);
    mtest_psz_eq(buf, "ab");

    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNA(buf, 0, "abc", 2);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_psz_eq(buf, "");
    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNA(buf, 1, "abc", 2);
    mtest_long_eq(hr, STRSAFE_E_INSUFFICIENT_BUFFER);
    mtest_psz_eq(buf, "");
    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNA(buf, 2, "abc", 2);
    mtest_long_eq(hr, STRSAFE_E_INSUFFICIENT_BUFFER);
    mtest_psz_eq(buf, "a");
    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNA(buf, 3, "abc", 2);
    mtest_long_eq(hr, S_OK);
    mtest_psz_eq(buf, "ab");
    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNA(buf, 4, "abc", 2);
    mtest_long_eq(hr, S_OK);
    mtest_psz_eq(buf, "ab");

    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNA(buf, 0, "", 3);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_psz_eq(buf, "");
    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNA(buf, 1, "", 3);
    mtest_long_eq(hr, S_OK);
    mtest_psz_eq(buf, "");
    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNA(buf, 2, "", 3);
    mtest_long_eq(hr, S_OK);
    mtest_psz_eq(buf, "");
    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNA(buf, 3, "", 3);
    mtest_long_eq(hr, S_OK);
    mtest_psz_eq(buf, "");
    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNA(buf, 4, "", 3);
    mtest_long_eq(hr, S_OK);
    mtest_psz_eq(buf, "");

    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNA(buf, 0, "a", 3);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_psz_eq(buf, "");
    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNA(buf, 1, "a", 3);
    mtest_long_eq(hr, STRSAFE_E_INSUFFICIENT_BUFFER);
    mtest_psz_eq(buf, "");
    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNA(buf, 2, "a", 3);
    mtest_long_eq(hr, S_OK);
    mtest_psz_eq(buf, "a");
    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNA(buf, 3, "a", 3);
    mtest_long_eq(hr, S_OK);
    mtest_psz_eq(buf, "a");
    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNA(buf, 4, "a", 3);
    mtest_long_eq(hr, S_OK);
    mtest_psz_eq(buf, "a");

    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNA(buf, 0, "ab", 3);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_psz_eq(buf, "");
    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNA(buf, 1, "ab", 3);
    mtest_long_eq(hr, STRSAFE_E_INSUFFICIENT_BUFFER);
    mtest_psz_eq(buf, "");
    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNA(buf, 2, "ab", 3);
    mtest_long_eq(hr, STRSAFE_E_INSUFFICIENT_BUFFER);
    mtest_psz_eq(buf, "a");
    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNA(buf, 3, "ab", 3);
    mtest_long_eq(hr, S_OK);
    mtest_psz_eq(buf, "ab");
    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNA(buf, 4, "ab", 3);
    mtest_long_eq(hr, S_OK);
    mtest_psz_eq(buf, "ab");

    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNA(buf, 0, "abc", 3);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_psz_eq(buf, "");
    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNA(buf, 1, "abc", 3);
    mtest_long_eq(hr, STRSAFE_E_INSUFFICIENT_BUFFER);
    mtest_psz_eq(buf, "");
    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNA(buf, 2, "abc", 3);
    mtest_long_eq(hr, STRSAFE_E_INSUFFICIENT_BUFFER);
    mtest_psz_eq(buf, "a");
    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNA(buf, 3, "abc", 3);
    mtest_long_eq(hr, STRSAFE_E_INSUFFICIENT_BUFFER);
    mtest_psz_eq(buf, "ab");
    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNA(buf, 4, "abc", 3);
    mtest_long_eq(hr, S_OK);
    mtest_psz_eq(buf, "abc");

    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNA(buf, 0, "", 4);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_psz_eq(buf, "");
    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNA(buf, 1, "", 4);
    mtest_long_eq(hr, S_OK);
    mtest_psz_eq(buf, "");
    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNA(buf, 2, "", 4);
    mtest_long_eq(hr, S_OK);
    mtest_psz_eq(buf, "");
    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNA(buf, 3, "", 4);
    mtest_long_eq(hr, S_OK);
    mtest_psz_eq(buf, "");
    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNA(buf, 4, "", 4);
    mtest_long_eq(hr, S_OK);
    mtest_psz_eq(buf, "");

    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNA(buf, 0, "a", 4);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_psz_eq(buf, "");
    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNA(buf, 1, "a", 4);
    mtest_long_eq(hr, STRSAFE_E_INSUFFICIENT_BUFFER);
    mtest_psz_eq(buf, "");
    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNA(buf, 2, "a", 4);
    mtest_long_eq(hr, S_OK);
    mtest_psz_eq(buf, "a");
    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNA(buf, 3, "a", 4);
    mtest_long_eq(hr, S_OK);
    mtest_psz_eq(buf, "a");
    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNA(buf, 4, "a", 4);
    mtest_long_eq(hr, S_OK);
    mtest_psz_eq(buf, "a");

    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNA(buf, 0, "ab", 4);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_psz_eq(buf, "");
    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNA(buf, 1, "ab", 4);
    mtest_long_eq(hr, STRSAFE_E_INSUFFICIENT_BUFFER);
    mtest_psz_eq(buf, "");
    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNA(buf, 2, "ab", 4);
    mtest_long_eq(hr, STRSAFE_E_INSUFFICIENT_BUFFER);
    mtest_psz_eq(buf, "a");
    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNA(buf, 3, "ab", 4);
    mtest_long_eq(hr, S_OK);
    mtest_psz_eq(buf, "ab");
    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNA(buf, 4, "ab", 4);
    mtest_long_eq(hr, S_OK);
    mtest_psz_eq(buf, "ab");

    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNA(buf, 0, "abc", 4);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_psz_eq(buf, "");
    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNA(buf, 1, "abc", 4);
    mtest_long_eq(hr, STRSAFE_E_INSUFFICIENT_BUFFER);
    mtest_psz_eq(buf, "");
    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNA(buf, 2, "abc", 4);
    mtest_long_eq(hr, STRSAFE_E_INSUFFICIENT_BUFFER);
    mtest_psz_eq(buf, "a");
    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNA(buf, 3, "abc", 4);
    mtest_long_eq(hr, STRSAFE_E_INSUFFICIENT_BUFFER);
    mtest_psz_eq(buf, "ab");
    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNA(buf, 4, "abc", 4);
    mtest_long_eq(hr, S_OK);
    mtest_psz_eq(buf, "abc");

    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatNA(buf, 0, "", 0);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_psz_eq(buf, "FFFF");
    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatNA(buf, 1, "", 0);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_psz_eq(buf, "FFFF");
    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatNA(buf, 2, "", 0);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_psz_eq(buf, "FFFF");
    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatNA(buf, 3, "", 0);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_psz_eq(buf, "FFFF");
    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatNA(buf, 4, "", 0);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_psz_eq(buf, "FFFF");

    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatNA(buf, 0, "a", 0);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_psz_eq(buf, "FFFF");
    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatNA(buf, 1, "a", 0);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_psz_eq(buf, "FFFF");
    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatNA(buf, 2, "a", 0);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_psz_eq(buf, "FFFF");
    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatNA(buf, 3, "a", 0);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_psz_eq(buf, "FFFF");
    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatNA(buf, 4, "a", 0);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_psz_eq(buf, "FFFF");

    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatNA(buf, 0, "ab", 0);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_psz_eq(buf, "FFFF");
    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatNA(buf, 1, "ab", 0);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_psz_eq(buf, "FFFF");
    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatNA(buf, 2, "ab", 0);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_psz_eq(buf, "FFFF");
    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatNA(buf, 3, "ab", 0);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_psz_eq(buf, "FFFF");
    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatNA(buf, 4, "ab", 0);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_psz_eq(buf, "FFFF");

    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatNA(buf, 0, "abc", 0);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_psz_eq(buf, "FFFF");
    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatNA(buf, 1, "abc", 0);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_psz_eq(buf, "FFFF");
    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatNA(buf, 2, "abc", 0);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_psz_eq(buf, "FFFF");
    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatNA(buf, 3, "abc", 0);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_psz_eq(buf, "FFFF");
    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatNA(buf, 4, "abc", 0);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_psz_eq(buf, "FFFF");

    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatNA(buf, 0, "", 1);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_psz_eq(buf, "FFFF");
    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatNA(buf, 1, "", 1);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_psz_eq(buf, "FFFF");
    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatNA(buf, 2, "", 1);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_psz_eq(buf, "FFFF");
    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatNA(buf, 3, "", 1);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_psz_eq(buf, "FFFF");
    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatNA(buf, 4, "", 1);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_psz_eq(buf, "FFFF");

    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatNA(buf, 0, "a", 1);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_psz_eq(buf, "FFFF");
    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatNA(buf, 1, "a", 1);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_psz_eq(buf, "FFFF");
    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatNA(buf, 2, "a", 1);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_psz_eq(buf, "FFFF");
    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatNA(buf, 3, "a", 1);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_psz_eq(buf, "FFFF");
    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatNA(buf, 4, "a", 1);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_psz_eq(buf, "FFFF");

    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatNA(buf, 0, "ab", 1);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_psz_eq(buf, "FFFF");
    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatNA(buf, 1, "ab", 1);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_psz_eq(buf, "FFFF");
    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatNA(buf, 2, "ab", 1);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_psz_eq(buf, "FFFF");
    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatNA(buf, 3, "ab", 1);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_psz_eq(buf, "FFFF");
    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatNA(buf, 4, "ab", 1);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_psz_eq(buf, "FFFF");

    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatNA(buf, 0, "abc", 1);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_psz_eq(buf, "FFFF");
    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatNA(buf, 1, "abc", 1);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_psz_eq(buf, "FFFF");
    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatNA(buf, 2, "abc", 1);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_psz_eq(buf, "FFFF");
    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatNA(buf, 3, "abc", 1);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_psz_eq(buf, "FFFF");
    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatNA(buf, 4, "abc", 1);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_psz_eq(buf, "FFFF");

    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatNA(buf, 0, "", 2);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_psz_eq(buf, "FFFF");
    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatNA(buf, 1, "", 2);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_psz_eq(buf, "FFFF");
    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatNA(buf, 2, "", 2);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_psz_eq(buf, "FFFF");
    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatNA(buf, 3, "", 2);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_psz_eq(buf, "FFFF");
    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatNA(buf, 4, "", 2);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_psz_eq(buf, "FFFF");

    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatNA(buf, 0, "a", 2);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_psz_eq(buf, "FFFF");
    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatNA(buf, 1, "a", 2);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_psz_eq(buf, "FFFF");
    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatNA(buf, 2, "a", 2);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_psz_eq(buf, "FFFF");
    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatNA(buf, 3, "a", 2);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_psz_eq(buf, "FFFF");
    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatNA(buf, 4, "a", 2);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_psz_eq(buf, "FFFF");

    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatNA(buf, 0, "ab", 2);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_psz_eq(buf, "FFFF");
    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatNA(buf, 1, "ab", 2);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_psz_eq(buf, "FFFF");
    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatNA(buf, 2, "ab", 2);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_psz_eq(buf, "FFFF");
    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatNA(buf, 3, "ab", 2);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_psz_eq(buf, "FFFF");
    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatNA(buf, 4, "ab", 2);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_psz_eq(buf, "FFFF");

    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatNA(buf, 0, "abc", 2);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_psz_eq(buf, "FFFF");
    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatNA(buf, 1, "abc", 2);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_psz_eq(buf, "FFFF");
    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatNA(buf, 2, "abc", 2);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_psz_eq(buf, "FFFF");
    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatNA(buf, 3, "abc", 2);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_psz_eq(buf, "FFFF");
    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatNA(buf, 4, "abc", 2);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_psz_eq(buf, "FFFF");

    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatNA(buf, 0, "", 3);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_psz_eq(buf, "FFFF");
    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatNA(buf, 1, "", 3);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_psz_eq(buf, "FFFF");
    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatNA(buf, 2, "", 3);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_psz_eq(buf, "FFFF");
    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatNA(buf, 3, "", 3);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_psz_eq(buf, "FFFF");
    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatNA(buf, 4, "", 3);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_psz_eq(buf, "FFFF");

    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatNA(buf, 0, "a", 3);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_psz_eq(buf, "FFFF");
    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatNA(buf, 1, "a", 3);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_psz_eq(buf, "FFFF");
    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatNA(buf, 2, "a", 3);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_psz_eq(buf, "FFFF");
    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatNA(buf, 3, "a", 3);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_psz_eq(buf, "FFFF");
    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatNA(buf, 4, "a", 3);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_psz_eq(buf, "FFFF");

    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatNA(buf, 0, "ab", 3);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_psz_eq(buf, "FFFF");
    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatNA(buf, 1, "ab", 3);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_psz_eq(buf, "FFFF");
    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatNA(buf, 2, "ab", 3);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_psz_eq(buf, "FFFF");
    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatNA(buf, 3, "ab", 3);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_psz_eq(buf, "FFFF");
    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatNA(buf, 4, "ab", 3);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_psz_eq(buf, "FFFF");

    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatNA(buf, 0, "abc", 3);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_psz_eq(buf, "FFFF");
    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatNA(buf, 1, "abc", 3);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_psz_eq(buf, "FFFF");
    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatNA(buf, 2, "abc", 3);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_psz_eq(buf, "FFFF");
    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatNA(buf, 3, "abc", 3);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_psz_eq(buf, "FFFF");
    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatNA(buf, 4, "abc", 3);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_psz_eq(buf, "FFFF");

    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatNA(buf, 0, "", 4);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_psz_eq(buf, "FFFF");
    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatNA(buf, 1, "", 4);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_psz_eq(buf, "FFFF");
    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatNA(buf, 2, "", 4);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_psz_eq(buf, "FFFF");
    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatNA(buf, 3, "", 4);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_psz_eq(buf, "FFFF");
    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatNA(buf, 4, "", 4);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_psz_eq(buf, "FFFF");

    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatNA(buf, 0, "a", 4);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_psz_eq(buf, "FFFF");
    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatNA(buf, 1, "a", 4);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_psz_eq(buf, "FFFF");
    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatNA(buf, 2, "a", 4);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_psz_eq(buf, "FFFF");
    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatNA(buf, 3, "a", 4);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_psz_eq(buf, "FFFF");
    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatNA(buf, 4, "a", 4);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_psz_eq(buf, "FFFF");

    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatNA(buf, 0, "ab", 4);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_psz_eq(buf, "FFFF");
    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatNA(buf, 1, "ab", 4);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_psz_eq(buf, "FFFF");
    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatNA(buf, 2, "ab", 4);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_psz_eq(buf, "FFFF");
    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatNA(buf, 3, "ab", 4);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_psz_eq(buf, "FFFF");
    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatNA(buf, 4, "ab", 4);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_psz_eq(buf, "FFFF");

    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatNA(buf, 0, "abc", 4);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_psz_eq(buf, "FFFF");
    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatNA(buf, 1, "abc", 4);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_psz_eq(buf, "FFFF");
    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatNA(buf, 2, "abc", 4);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_psz_eq(buf, "FFFF");
    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatNA(buf, 3, "abc", 4);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_psz_eq(buf, "FFFF");
    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatNA(buf, 4, "abc", 4);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_psz_eq(buf, "FFFF");
}

START_TEST(StringCchCopyNA)
{
    char buf[BUFSIZE];
    HRESULT hr;

    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNA(buf, INVALID_LENGTH, "a", 0);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    //mtest_psz_eq(buf, "FFFFFFF"); // can be ''

    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNA(buf, 0, "a", INVALID_LENGTH);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_psz_eq(buf, "FFFFFFF");

    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNA(buf, 0, "", 0);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_psz_eq(buf, "FFFFFFF");
    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNA(buf, 1, "", 0);
    mtest_long_eq(hr, S_OK);
    mtest_psz_eq(buf, "");
    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNA(buf, 2, "", 0);
    mtest_long_eq(hr, S_OK);
    mtest_psz_eq(buf, "");
    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNA(buf, 3, "", 0);
    mtest_long_eq(hr, S_OK);
    mtest_psz_eq(buf, "");
    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNA(buf, 4, "", 0);
    mtest_long_eq(hr, S_OK);
    mtest_psz_eq(buf, "");

    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNA(buf, 0, "a", 0);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_psz_eq(buf, "FFFFFFF");
    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNA(buf, 1, "a", 0);
    mtest_long_eq(hr, S_OK);
    mtest_psz_eq(buf, "");
    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNA(buf, 2, "a", 0);
    mtest_long_eq(hr, S_OK);
    mtest_psz_eq(buf, "");
    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNA(buf, 3, "a", 0);
    mtest_long_eq(hr, S_OK);
    mtest_psz_eq(buf, "");
    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNA(buf, 4, "a", 0);
    mtest_long_eq(hr, S_OK);
    mtest_psz_eq(buf, "");

    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNA(buf, 0, "ab", 0);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_psz_eq(buf, "FFFFFFF");
    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNA(buf, 1, "ab", 0);
    mtest_long_eq(hr, S_OK);
    mtest_psz_eq(buf, "");
    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNA(buf, 2, "ab", 0);
    mtest_long_eq(hr, S_OK);
    mtest_psz_eq(buf, "");
    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNA(buf, 3, "ab", 0);
    mtest_long_eq(hr, S_OK);
    mtest_psz_eq(buf, "");
    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNA(buf, 4, "ab", 0);
    mtest_long_eq(hr, S_OK);
    mtest_psz_eq(buf, "");

    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNA(buf, 0, "abc", 0);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_psz_eq(buf, "FFFFFFF");
    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNA(buf, 1, "abc", 0);
    mtest_long_eq(hr, S_OK);
    mtest_psz_eq(buf, "");
    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNA(buf, 2, "abc", 0);
    mtest_long_eq(hr, S_OK);
    mtest_psz_eq(buf, "");
    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNA(buf, 3, "abc", 0);
    mtest_long_eq(hr, S_OK);
    mtest_psz_eq(buf, "");
    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNA(buf, 4, "abc", 0);
    mtest_long_eq(hr, S_OK);
    mtest_psz_eq(buf, "");

    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNA(buf, 0, "", 1);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_psz_eq(buf, "FFFFFFF");
    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNA(buf, 1, "", 1);
    mtest_long_eq(hr, S_OK);
    mtest_psz_eq(buf, "");
    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNA(buf, 2, "", 1);
    mtest_long_eq(hr, S_OK);
    mtest_psz_eq(buf, "");
    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNA(buf, 3, "", 1);
    mtest_long_eq(hr, S_OK);
    mtest_psz_eq(buf, "");
    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNA(buf, 4, "", 1);
    mtest_long_eq(hr, S_OK);
    mtest_psz_eq(buf, "");

    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNA(buf, 0, "a", 1);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_psz_eq(buf, "FFFFFFF");
    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNA(buf, 1, "a", 1);
    mtest_long_eq(hr, STRSAFE_E_INSUFFICIENT_BUFFER);
    mtest_psz_eq(buf, "");
    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNA(buf, 2, "a", 1);
    mtest_long_eq(hr, S_OK);
    mtest_psz_eq(buf, "a");
    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNA(buf, 3, "a", 1);
    mtest_long_eq(hr, S_OK);
    mtest_psz_eq(buf, "a");
    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNA(buf, 4, "a", 1);
    mtest_long_eq(hr, S_OK);
    mtest_psz_eq(buf, "a");

    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNA(buf, 0, "ab", 1);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_psz_eq(buf, "FFFFFFF");
    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNA(buf, 1, "ab", 1);
    mtest_long_eq(hr, STRSAFE_E_INSUFFICIENT_BUFFER);
    mtest_psz_eq(buf, "");
    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNA(buf, 2, "ab", 1);
    mtest_long_eq(hr, S_OK);
    mtest_psz_eq(buf, "a");
    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNA(buf, 3, "ab", 1);
    mtest_long_eq(hr, S_OK);
    mtest_psz_eq(buf, "a");
    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNA(buf, 4, "ab", 1);
    mtest_long_eq(hr, S_OK);
    mtest_psz_eq(buf, "a");

    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNA(buf, 0, "abc", 1);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_psz_eq(buf, "FFFFFFF");
    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNA(buf, 1, "abc", 1);
    mtest_long_eq(hr, STRSAFE_E_INSUFFICIENT_BUFFER);
    mtest_psz_eq(buf, "");
    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNA(buf, 2, "abc", 1);
    mtest_long_eq(hr, S_OK);
    mtest_psz_eq(buf, "a");
    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNA(buf, 3, "abc", 1);
    mtest_long_eq(hr, S_OK);
    mtest_psz_eq(buf, "a");
    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNA(buf, 4, "abc", 1);
    mtest_long_eq(hr, S_OK);
    mtest_psz_eq(buf, "a");

    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNA(buf, 0, "", 2);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_psz_eq(buf, "FFFFFFF");
    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNA(buf, 1, "", 2);
    mtest_long_eq(hr, S_OK);
    mtest_psz_eq(buf, "");
    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNA(buf, 2, "", 2);
    mtest_long_eq(hr, S_OK);
    mtest_psz_eq(buf, "");
    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNA(buf, 3, "", 2);
    mtest_long_eq(hr, S_OK);
    mtest_psz_eq(buf, "");
    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNA(buf, 4, "", 2);
    mtest_long_eq(hr, S_OK);
    mtest_psz_eq(buf, "");

    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNA(buf, 0, "a", 2);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_psz_eq(buf, "FFFFFFF");
    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNA(buf, 1, "a", 2);
    mtest_long_eq(hr, STRSAFE_E_INSUFFICIENT_BUFFER);
    mtest_psz_eq(buf, "");
    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNA(buf, 2, "a", 2);
    mtest_long_eq(hr, S_OK);
    mtest_psz_eq(buf, "a");
    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNA(buf, 3, "a", 2);
    mtest_long_eq(hr, S_OK);
    mtest_psz_eq(buf, "a");
    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNA(buf, 4, "a", 2);
    mtest_long_eq(hr, S_OK);
    mtest_psz_eq(buf, "a");

    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNA(buf, 0, "ab", 2);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_psz_eq(buf, "FFFFFFF");
    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNA(buf, 1, "ab", 2);
    mtest_long_eq(hr, STRSAFE_E_INSUFFICIENT_BUFFER);
    mtest_psz_eq(buf, "");
    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNA(buf, 2, "ab", 2);
    mtest_long_eq(hr, STRSAFE_E_INSUFFICIENT_BUFFER);
    mtest_psz_eq(buf, "a");
    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNA(buf, 3, "ab", 2);
    mtest_long_eq(hr, S_OK);
    mtest_psz_eq(buf, "ab");
    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNA(buf, 4, "ab", 2);
    mtest_long_eq(hr, S_OK);
    mtest_psz_eq(buf, "ab");

    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNA(buf, 0, "abc", 2);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_psz_eq(buf, "FFFFFFF");
    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNA(buf, 1, "abc", 2);
    mtest_long_eq(hr, STRSAFE_E_INSUFFICIENT_BUFFER);
    mtest_psz_eq(buf, "");
    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNA(buf, 2, "abc", 2);
    mtest_long_eq(hr, STRSAFE_E_INSUFFICIENT_BUFFER);
    mtest_psz_eq(buf, "a");
    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNA(buf, 3, "abc", 2);
    mtest_long_eq(hr, S_OK);
    mtest_psz_eq(buf, "ab");
    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNA(buf, 4, "abc", 2);
    mtest_long_eq(hr, S_OK);
    mtest_psz_eq(buf, "ab");

    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNA(buf, 0, "", 3);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_psz_eq(buf, "FFFFFFF");
    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNA(buf, 1, "", 3);
    mtest_long_eq(hr, S_OK);
    mtest_psz_eq(buf, "");
    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNA(buf, 2, "", 3);
    mtest_long_eq(hr, S_OK);
    mtest_psz_eq(buf, "");
    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNA(buf, 3, "", 3);
    mtest_long_eq(hr, S_OK);
    mtest_psz_eq(buf, "");
    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNA(buf, 4, "", 3);
    mtest_long_eq(hr, S_OK);
    mtest_psz_eq(buf, "");

    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNA(buf, 0, "a", 3);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_psz_eq(buf, "FFFFFFF");
    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNA(buf, 1, "a", 3);
    mtest_long_eq(hr, STRSAFE_E_INSUFFICIENT_BUFFER);
    mtest_psz_eq(buf, "");
    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNA(buf, 2, "a", 3);
    mtest_long_eq(hr, S_OK);
    mtest_psz_eq(buf, "a");
    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNA(buf, 3, "a", 3);
    mtest_long_eq(hr, S_OK);
    mtest_psz_eq(buf, "a");
    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNA(buf, 4, "a", 3);
    mtest_long_eq(hr, S_OK);
    mtest_psz_eq(buf, "a");

    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNA(buf, 0, "ab", 3);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_psz_eq(buf, "FFFFFFF");
    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNA(buf, 1, "ab", 3);
    mtest_long_eq(hr, STRSAFE_E_INSUFFICIENT_BUFFER);
    mtest_psz_eq(buf, "");
    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNA(buf, 2, "ab", 3);
    mtest_long_eq(hr, STRSAFE_E_INSUFFICIENT_BUFFER);
    mtest_psz_eq(buf, "a");
    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNA(buf, 3, "ab", 3);
    mtest_long_eq(hr, S_OK);
    mtest_psz_eq(buf, "ab");
    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNA(buf, 4, "ab", 3);
    mtest_long_eq(hr, S_OK);
    mtest_psz_eq(buf, "ab");

    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNA(buf, 0, "abc", 3);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_psz_eq(buf, "FFFFFFF");
    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNA(buf, 1, "abc", 3);
    mtest_long_eq(hr, STRSAFE_E_INSUFFICIENT_BUFFER);
    mtest_psz_eq(buf, "");
    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNA(buf, 2, "abc", 3);
    mtest_long_eq(hr, STRSAFE_E_INSUFFICIENT_BUFFER);
    mtest_psz_eq(buf, "a");
    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNA(buf, 3, "abc", 3);
    mtest_long_eq(hr, STRSAFE_E_INSUFFICIENT_BUFFER);
    mtest_psz_eq(buf, "ab");
    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNA(buf, 4, "abc", 3);
    mtest_long_eq(hr, S_OK);
    mtest_psz_eq(buf, "abc");

    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNA(buf, 0, "", 4);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_psz_eq(buf, "FFFFFFF");
    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNA(buf, 1, "", 4);
    mtest_long_eq(hr, S_OK);
    mtest_psz_eq(buf, "");
    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNA(buf, 2, "", 4);
    mtest_long_eq(hr, S_OK);
    mtest_psz_eq(buf, "");
    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNA(buf, 3, "", 4);
    mtest_long_eq(hr, S_OK);
    mtest_psz_eq(buf, "");
    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNA(buf, 4, "", 4);
    mtest_long_eq(hr, S_OK);
    mtest_psz_eq(buf, "");

    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNA(buf, 0, "a", 4);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_psz_eq(buf, "FFFFFFF");
    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNA(buf, 1, "a", 4);
    mtest_long_eq(hr, STRSAFE_E_INSUFFICIENT_BUFFER);
    mtest_psz_eq(buf, "");
    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNA(buf, 2, "a", 4);
    mtest_long_eq(hr, S_OK);
    mtest_psz_eq(buf, "a");
    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNA(buf, 3, "a", 4);
    mtest_long_eq(hr, S_OK);
    mtest_psz_eq(buf, "a");
    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNA(buf, 4, "a", 4);
    mtest_long_eq(hr, S_OK);
    mtest_psz_eq(buf, "a");

    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNA(buf, 0, "ab", 4);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_psz_eq(buf, "FFFFFFF");
    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNA(buf, 1, "ab", 4);
    mtest_long_eq(hr, STRSAFE_E_INSUFFICIENT_BUFFER);
    mtest_psz_eq(buf, "");
    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNA(buf, 2, "ab", 4);
    mtest_long_eq(hr, STRSAFE_E_INSUFFICIENT_BUFFER);
    mtest_psz_eq(buf, "a");
    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNA(buf, 3, "ab", 4);
    mtest_long_eq(hr, S_OK);
    mtest_psz_eq(buf, "ab");
    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNA(buf, 4, "ab", 4);
    mtest_long_eq(hr, S_OK);
    mtest_psz_eq(buf, "ab");

    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNA(buf, 0, "abc", 4);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_psz_eq(buf, "FFFFFFF");
    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNA(buf, 1, "abc", 4);
    mtest_long_eq(hr, STRSAFE_E_INSUFFICIENT_BUFFER);
    mtest_psz_eq(buf, "");
    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNA(buf, 2, "abc", 4);
    mtest_long_eq(hr, STRSAFE_E_INSUFFICIENT_BUFFER);
    mtest_psz_eq(buf, "a");
    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNA(buf, 3, "abc", 4);
    mtest_long_eq(hr, STRSAFE_E_INSUFFICIENT_BUFFER);
    mtest_psz_eq(buf, "ab");
    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNA(buf, 4, "abc", 4);
    mtest_long_eq(hr, S_OK);
    mtest_psz_eq(buf, "abc");
}

START_TEST(StringCchPrintfA)
{
    char buf[BUFSIZE];
    HRESULT hr;

    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchPrintfA(buf, INVALID_LENGTH, "%d", 1234);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    //mtest_psz_eq(buf, "FFFFFFF"); // can be ''

    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchPrintfA(buf, 0, "%d", 1234);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_psz_eq(buf, "FFFFFFF");

    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchPrintfA(buf, 1, "%d", 1234);
    mtest_long_eq(hr, STRSAFE_E_INSUFFICIENT_BUFFER);
    mtest_psz_eq(buf, "");

    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchPrintfA(buf, 2, "%d", 1234);
    mtest_long_eq(hr, STRSAFE_E_INSUFFICIENT_BUFFER);
    mtest_psz_eq(buf, "1");

    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchPrintfA(buf, 3, "%d", 1234);
    mtest_long_eq(hr, STRSAFE_E_INSUFFICIENT_BUFFER);
    mtest_psz_eq(buf, "12");

    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchPrintfA(buf, 4, "%d", 1234);
    mtest_long_eq(hr, STRSAFE_E_INSUFFICIENT_BUFFER);
    mtest_psz_eq(buf, "123");

    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchPrintfA(buf, 5, "%d", 1234);
    mtest_long_eq(hr, S_OK);
    mtest_psz_eq(buf, "1234");

    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchPrintfA(buf, 0, "%s", "1234");
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_psz_eq(buf, "FFFFFFF");

    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchPrintfA(buf, 1, "%s", "1234");
    mtest_long_eq(hr, STRSAFE_E_INSUFFICIENT_BUFFER);
    mtest_psz_eq(buf, "");

    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchPrintfA(buf, 2, "%s", "1234");
    mtest_long_eq(hr, STRSAFE_E_INSUFFICIENT_BUFFER);
    mtest_psz_eq(buf, "1");

    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchPrintfA(buf, 3, "%s", "1234");
    mtest_long_eq(hr, STRSAFE_E_INSUFFICIENT_BUFFER);
    mtest_psz_eq(buf, "12");

    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchPrintfA(buf, 4, "%s", "1234");
    mtest_long_eq(hr, STRSAFE_E_INSUFFICIENT_BUFFER);
    mtest_psz_eq(buf, "123");

    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchPrintfA(buf, 5, "%s", "1234");
    mtest_long_eq(hr, S_OK);
    mtest_psz_eq(buf, "1234");
}

static HRESULT
vprintf_test_helperA(
    char *pszDest,
    size_t cchDest,
    const char *pszFormat,
    ...)
{
    va_list va;
    HRESULT hr;
    va_start(va, pszFormat);
    hr = StringCchVPrintfA(pszDest, cchDest, pszFormat, va);
    va_end(va);
    return hr;
}

START_TEST(StringCchVPrintfA)
{
    char buf[BUFSIZE];
    HRESULT hr;

    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = vprintf_test_helperA(buf, INVALID_LENGTH, "%d", 1234);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    //mtest_psz_eq(buf, "FFFFFFF"); // can be ''

    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = vprintf_test_helperA(buf, 0, "%d", 1234);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_psz_eq(buf, "FFFFFFF");

    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = vprintf_test_helperA(buf, 1, "%d", 1234);
    mtest_long_eq(hr, STRSAFE_E_INSUFFICIENT_BUFFER);
    mtest_psz_eq(buf, "");

    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = vprintf_test_helperA(buf, 2, "%d", 1234);
    mtest_long_eq(hr, STRSAFE_E_INSUFFICIENT_BUFFER);
    mtest_psz_eq(buf, "1");

    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = vprintf_test_helperA(buf, 3, "%d", 1234);
    mtest_long_eq(hr, STRSAFE_E_INSUFFICIENT_BUFFER);
    mtest_psz_eq(buf, "12");

    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = vprintf_test_helperA(buf, 4, "%d", 1234);
    mtest_long_eq(hr, STRSAFE_E_INSUFFICIENT_BUFFER);
    mtest_psz_eq(buf, "123");

    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = vprintf_test_helperA(buf, 5, "%d", 1234);
    mtest_long_eq(hr, S_OK);
    mtest_psz_eq(buf, "1234");

    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = vprintf_test_helperA(buf, 0, "%s", "1234");
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_psz_eq(buf, "FFFFFFF");

    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = vprintf_test_helperA(buf, 1, "%s", "1234");
    mtest_long_eq(hr, STRSAFE_E_INSUFFICIENT_BUFFER);
    mtest_psz_eq(buf, "");

    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = vprintf_test_helperA(buf, 2, "%s", "1234");
    mtest_long_eq(hr, STRSAFE_E_INSUFFICIENT_BUFFER);
    mtest_psz_eq(buf, "1");

    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = vprintf_test_helperA(buf, 3, "%s", "1234");
    mtest_long_eq(hr, STRSAFE_E_INSUFFICIENT_BUFFER);
    mtest_psz_eq(buf, "12");

    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = vprintf_test_helperA(buf, 4, "%s", "1234");
    mtest_long_eq(hr, STRSAFE_E_INSUFFICIENT_BUFFER);
    mtest_psz_eq(buf, "123");

    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = vprintf_test_helperA(buf, 5, "%s", "1234");
    mtest_long_eq(hr, S_OK);
    mtest_psz_eq(buf, "1234");
}


START_TEST(StringCchLengthA)
{
    size_t cch;
    HRESULT hr;

    cch = 123;
    hr = StringCchLengthA("a", INVALID_LENGTH, &cch);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest(cch == 0, "%d\n", (int)cch);

    cch = 123;
    hr = StringCchLengthA("", 0, &cch);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest(cch == 0, "%d\n", (int)cch);
    cch = 123;
    hr = StringCchLengthA("", 1, &cch);
    mtest_long_eq(hr, S_OK);
    mtest(cch == 0, "%d\n", (int)cch);
    cch = 123;
    hr = StringCchLengthA("", 2, &cch);
    mtest_long_eq(hr, S_OK);
    mtest(cch == 0, "%d\n", (int)cch);
    cch = 123;
    hr = StringCchLengthA("", 3, &cch);
    mtest_long_eq(hr, S_OK);
    mtest(cch == 0, "%d\n", (int)cch);

    cch = 123;
    hr = StringCchLengthA("a", 0, &cch);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest(cch == 0, "%d\n", (int)cch);
    cch = 123;
    hr = StringCchLengthA("a", 1, &cch);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest(cch == 0, "%d\n", (int)cch);
    cch = 123;
    hr = StringCchLengthA("a", 2, &cch);
    mtest_long_eq(hr, S_OK);
    mtest(cch == 1, "%d\n", (int)cch);
    cch = 123;
    hr = StringCchLengthA("a", 3, &cch);
    mtest_long_eq(hr, S_OK);
    mtest(cch == 1, "%d\n", (int)cch);

    cch = 123;
    hr = StringCchLengthA("ab", 0, &cch);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest(cch == 0, "%d\n", (int)cch);
    cch = 123;
    hr = StringCchLengthA("ab", 1, &cch);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest(cch == 0, "%d\n", (int)cch);
    cch = 123;
    hr = StringCchLengthA("ab", 2, &cch);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest(cch == 0, "%d\n", (int)cch);
    cch = 123;
    hr = StringCchLengthA("ab", 3, &cch);
    mtest_long_eq(hr, S_OK);
    mtest(cch == 2, "%d\n", (int)cch);

    cch = 123;
    hr = StringCchLengthA("abc", 0, &cch);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest(cch == 0, "%d\n", (int)cch);
    cch = 123;
    hr = StringCchLengthA("abc", 1, &cch);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest(cch == 0, "%d\n", (int)cch);
    cch = 123;
    hr = StringCchLengthA("abc", 2, &cch);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest(cch == 0, "%d\n", (int)cch);
    cch = 123;
    hr = StringCchLengthA("abc", 3, &cch);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest(cch == 0, "%d\n", (int)cch);

    cch = 123;
    hr = StringCchLengthA("abcd", 0, &cch);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest(cch == 0, "%d\n", (int)cch);
    cch = 123;
    hr = StringCchLengthA("abcd", 1, &cch);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest(cch == 0, "%d\n", (int)cch);
    cch = 123;
    hr = StringCchLengthA("abcd", 2, &cch);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest(cch == 0, "%d\n", (int)cch);
    cch = 123;
    hr = StringCchLengthA("abcd", 3, &cch);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest(cch == 0, "%d\n", (int)cch);
}

#ifdef _WIN32
START_TEST(StringCchCopyW)
{
    wchar_t buf[BUFSIZE];
    HRESULT hr;

    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyW(buf, INVALID_LENGTH, L"a");
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    //mtest_pwsz_eq(buf, L"FFFFFFF"); // can be ''

    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyW(buf, 0, L"");
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_pwsz_eq(buf, L"FFFFFFF");
    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyW(buf, 1, L"");
    mtest_long_eq(hr, S_OK);
    mtest_pwsz_eq(buf, L"");
    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyW(buf, 2, L"");
    mtest_long_eq(hr, S_OK);
    mtest_pwsz_eq(buf, L"");
    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyW(buf, 3, L"");
    mtest_long_eq(hr, S_OK);
    mtest_pwsz_eq(buf, L"");
    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyW(buf, 4, L"");
    mtest_long_eq(hr, S_OK);
    mtest_pwsz_eq(buf, L"");

    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyW(buf, 0, L"a");
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_pwsz_eq(buf, L"FFFFFFF");
    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyW(buf, 1, L"a");
    mtest_long_eq(hr, STRSAFE_E_INSUFFICIENT_BUFFER);
    mtest_pwsz_eq(buf, L"");
    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyW(buf, 2, L"a");
    mtest_long_eq(hr, S_OK);
    mtest_pwsz_eq(buf, L"a");
    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyW(buf, 3, L"a");
    mtest_long_eq(hr, S_OK);
    mtest_pwsz_eq(buf, L"a");
    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyW(buf, 4, L"a");
    mtest_long_eq(hr, S_OK);
    mtest_pwsz_eq(buf, L"a");

    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyW(buf, 0, L"ab");
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_pwsz_eq(buf, L"FFFFFFF");
    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyW(buf, 1, L"ab");
    mtest_long_eq(hr, STRSAFE_E_INSUFFICIENT_BUFFER);
    mtest_pwsz_eq(buf, L"");
    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyW(buf, 2, L"ab");
    mtest_long_eq(hr, STRSAFE_E_INSUFFICIENT_BUFFER);
    mtest_pwsz_eq(buf, L"a");
    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyW(buf, 3, L"ab");
    mtest_long_eq(hr, S_OK);
    mtest_pwsz_eq(buf, L"ab");
    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyW(buf, 4, L"ab");
    mtest_long_eq(hr, S_OK);
    mtest_pwsz_eq(buf, L"ab");

    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyW(buf, 0, L"abc");
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_pwsz_eq(buf, L"FFFFFFF");
    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyW(buf, 1, L"abc");
    mtest_long_eq(hr, STRSAFE_E_INSUFFICIENT_BUFFER);
    mtest_pwsz_eq(buf, L"");
    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyW(buf, 2, L"abc");
    mtest_long_eq(hr, STRSAFE_E_INSUFFICIENT_BUFFER);
    mtest_pwsz_eq(buf, L"a");
    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyW(buf, 3, L"abc");
    mtest_long_eq(hr, STRSAFE_E_INSUFFICIENT_BUFFER);
    mtest_pwsz_eq(buf, L"ab");
    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyW(buf, 4, L"abc");
    mtest_long_eq(hr, S_OK);
    mtest_pwsz_eq(buf, L"abc");
}

START_TEST(StringCchCatW)
{
    wchar_t buf[BUFSIZE];
    HRESULT hr;

    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatW(buf, INVALID_LENGTH, L"a");
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_pwsz_eq(buf, L"");

    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatW(buf, 0, L"");
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_pwsz_eq(buf, L"");
    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatW(buf, 1, L"");
    mtest_long_eq(hr, S_OK);
    mtest_pwsz_eq(buf, L"");
    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatW(buf, 2, L"");
    mtest_long_eq(hr, S_OK);
    mtest_pwsz_eq(buf, L"");
    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatW(buf, 3, L"");
    mtest_long_eq(hr, S_OK);
    mtest_pwsz_eq(buf, L"");
    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatW(buf, 4, L"");
    mtest_long_eq(hr, S_OK);
    mtest_pwsz_eq(buf, L"");

    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatW(buf, 0, L"a");
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_pwsz_eq(buf, L"");
    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatW(buf, 1, L"a");
    mtest_long_eq(hr, STRSAFE_E_INSUFFICIENT_BUFFER);
    mtest_pwsz_eq(buf, L"");
    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatW(buf, 2, L"a");
    mtest_long_eq(hr, S_OK);
    mtest_pwsz_eq(buf, L"a");
    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatW(buf, 3, L"a");
    mtest_long_eq(hr, S_OK);
    mtest_pwsz_eq(buf, L"a");
    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatW(buf, 4, L"a");
    mtest_long_eq(hr, S_OK);
    mtest_pwsz_eq(buf, L"a");

    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatW(buf, 0, L"ab");
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_pwsz_eq(buf, L"");
    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatW(buf, 1, L"ab");
    mtest_long_eq(hr, STRSAFE_E_INSUFFICIENT_BUFFER);
    mtest_pwsz_eq(buf, L"");
    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatW(buf, 2, L"ab");
    mtest_long_eq(hr, STRSAFE_E_INSUFFICIENT_BUFFER);
    mtest_pwsz_eq(buf, L"a");
    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatW(buf, 3, L"ab");
    mtest_long_eq(hr, S_OK);
    mtest_pwsz_eq(buf, L"ab");
    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatW(buf, 4, L"ab");
    mtest_long_eq(hr, S_OK);
    mtest_pwsz_eq(buf, L"ab");

    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatW(buf, 0, L"abc");
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_pwsz_eq(buf, L"");
    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatW(buf, 1, L"abc");
    mtest_long_eq(hr, STRSAFE_E_INSUFFICIENT_BUFFER);
    mtest_pwsz_eq(buf, L"");
    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatW(buf, 2, L"abc");
    mtest_long_eq(hr, STRSAFE_E_INSUFFICIENT_BUFFER);
    mtest_pwsz_eq(buf, L"a");
    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatW(buf, 3, L"abc");
    mtest_long_eq(hr, STRSAFE_E_INSUFFICIENT_BUFFER);
    mtest_pwsz_eq(buf, L"ab");
    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatW(buf, 4, L"abc");
    mtest_long_eq(hr, S_OK);
    mtest_pwsz_eq(buf, L"abc");

    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatW(buf, 0, L"");
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_pwsz_eq(buf, L"FFFF");
    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatW(buf, 1, L"");
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_pwsz_eq(buf, L"FFFF");
    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatW(buf, 2, L"");
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_pwsz_eq(buf, L"FFFF");
    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatW(buf, 3, L"");
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_pwsz_eq(buf, L"FFFF");
    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatW(buf, 4, L"");
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_pwsz_eq(buf, L"FFFF");

    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatW(buf, 0, L"a");
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_pwsz_eq(buf, L"FFFF");
    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatW(buf, 1, L"a");
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_pwsz_eq(buf, L"FFFF");
    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatW(buf, 2, L"a");
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_pwsz_eq(buf, L"FFFF");
    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatW(buf, 3, L"a");
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_pwsz_eq(buf, L"FFFF");
    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatW(buf, 4, L"a");
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_pwsz_eq(buf, L"FFFF");

    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatW(buf, 0, L"ab");
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_pwsz_eq(buf, L"FFFF");
    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatW(buf, 1, L"ab");
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_pwsz_eq(buf, L"FFFF");
    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatW(buf, 2, L"ab");
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_pwsz_eq(buf, L"FFFF");
    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatW(buf, 3, L"ab");
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_pwsz_eq(buf, L"FFFF");
    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatW(buf, 4, L"ab");
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_pwsz_eq(buf, L"FFFF");

    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatW(buf, 0, L"abc");
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_pwsz_eq(buf, L"FFFF");
    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatW(buf, 1, L"abc");
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_pwsz_eq(buf, L"FFFF");
    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatW(buf, 2, L"abc");
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_pwsz_eq(buf, L"FFFF");
    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatW(buf, 3, L"abc");
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_pwsz_eq(buf, L"FFFF");
    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatW(buf, 4, L"abc");
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_pwsz_eq(buf, L"FFFF");
}

START_TEST(StringCchCatNW)
{
    wchar_t buf[BUFSIZE];
    HRESULT hr;

    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNW(buf, INVALID_LENGTH, L"a", 1);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_pwsz_eq(buf, L"");

    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNW(buf, 1, L"a", INVALID_LENGTH);
    //mtest_long_eq(hr, STRSAFE_E_INSUFFICIENT_BUFFER); // can be STRSAFE_E_INVALID_PARAMETER
    mtest_pwsz_eq(buf, L"");

    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNW(buf, 0, L"", 0);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_pwsz_eq(buf, L"");
    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNW(buf, 1, L"", 0);
    mtest_long_eq(hr, S_OK);
    mtest_pwsz_eq(buf, L"");
    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNW(buf, 2, L"", 0);
    mtest_long_eq(hr, S_OK);
    mtest_pwsz_eq(buf, L"");
    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNW(buf, 3, L"", 0);
    mtest_long_eq(hr, S_OK);
    mtest_pwsz_eq(buf, L"");
    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNW(buf, 4, L"", 0);
    mtest_long_eq(hr, S_OK);
    mtest_pwsz_eq(buf, L"");

    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNW(buf, 0, L"a", 0);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_pwsz_eq(buf, L"");
    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNW(buf, 1, L"a", 0);
    mtest_long_eq(hr, S_OK);
    mtest_pwsz_eq(buf, L"");
    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNW(buf, 2, L"a", 0);
    mtest_long_eq(hr, S_OK);
    mtest_pwsz_eq(buf, L"");
    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNW(buf, 3, L"a", 0);
    mtest_long_eq(hr, S_OK);
    mtest_pwsz_eq(buf, L"");
    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNW(buf, 4, L"a", 0);
    mtest_long_eq(hr, S_OK);
    mtest_pwsz_eq(buf, L"");

    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNW(buf, 0, L"ab", 0);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_pwsz_eq(buf, L"");
    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNW(buf, 1, L"ab", 0);
    mtest_long_eq(hr, S_OK);
    mtest_pwsz_eq(buf, L"");
    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNW(buf, 2, L"ab", 0);
    mtest_long_eq(hr, S_OK);
    mtest_pwsz_eq(buf, L"");
    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNW(buf, 3, L"ab", 0);
    mtest_long_eq(hr, S_OK);
    mtest_pwsz_eq(buf, L"");
    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNW(buf, 4, L"ab", 0);
    mtest_long_eq(hr, S_OK);
    mtest_pwsz_eq(buf, L"");

    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNW(buf, 0, L"abc", 0);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER );
    mtest_pwsz_eq(buf, L"");
    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNW(buf, 1, L"abc", 0);
    mtest_long_eq(hr, S_OK);
    mtest_pwsz_eq(buf, L"");
    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNW(buf, 2, L"abc", 0);
    mtest_long_eq(hr, S_OK);
    mtest_pwsz_eq(buf, L"");
    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNW(buf, 3, L"abc", 0);
    mtest_long_eq(hr, S_OK);
    mtest_pwsz_eq(buf, L"");
    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNW(buf, 4, L"abc", 0);
    mtest_long_eq(hr, S_OK);
    mtest_pwsz_eq(buf, L"");

    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNW(buf, 0, L"", 1);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_pwsz_eq(buf, L"");
    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNW(buf, 1, L"", 1);
    mtest_long_eq(hr, S_OK);
    mtest_pwsz_eq(buf, L"");
    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNW(buf, 2, L"", 1);
    mtest_long_eq(hr, S_OK);
    mtest_pwsz_eq(buf, L"");
    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNW(buf, 3, L"", 1);
    mtest_long_eq(hr, S_OK);
    mtest_pwsz_eq(buf, L"");
    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNW(buf, 4, L"", 1);
    mtest_long_eq(hr, S_OK);
    mtest_pwsz_eq(buf, L"");

    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNW(buf, 0, L"a", 1);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_pwsz_eq(buf, L"");
    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNW(buf, 1, L"a", 1);
    mtest_long_eq(hr, STRSAFE_E_INSUFFICIENT_BUFFER);
    mtest_pwsz_eq(buf, L"");
    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNW(buf, 2, L"a", 1);
    mtest_long_eq(hr, S_OK);
    mtest_pwsz_eq(buf, L"a");
    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNW(buf, 3, L"a", 1);
    mtest_long_eq(hr, S_OK);
    mtest_pwsz_eq(buf, L"a");
    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNW(buf, 4, L"a", 1);
    mtest_long_eq(hr, S_OK);
    mtest_pwsz_eq(buf, L"a");

    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNW(buf, 0, L"ab", 1);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_pwsz_eq(buf, L"");
    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNW(buf, 1, L"ab", 1);
    mtest_long_eq(hr, STRSAFE_E_INSUFFICIENT_BUFFER);
    mtest_pwsz_eq(buf, L"");
    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNW(buf, 2, L"ab", 1);
    mtest_long_eq(hr, S_OK);
    mtest_pwsz_eq(buf, L"a");
    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNW(buf, 3, L"ab", 1);
    mtest_long_eq(hr, S_OK);
    mtest_pwsz_eq(buf, L"a");
    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNW(buf, 4, L"ab", 1);
    mtest_long_eq(hr, S_OK);
    mtest_pwsz_eq(buf, L"a");

    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNW(buf, 0, L"abc", 1);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_pwsz_eq(buf, L"");
    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNW(buf, 1, L"abc", 1);
    mtest_long_eq(hr, STRSAFE_E_INSUFFICIENT_BUFFER);
    mtest_pwsz_eq(buf, L"");
    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNW(buf, 2, L"abc", 1);
    mtest_long_eq(hr, S_OK);
    mtest_pwsz_eq(buf, L"a");
    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNW(buf, 3, L"abc", 1);
    mtest_long_eq(hr, S_OK);
    mtest_pwsz_eq(buf, L"a");
    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNW(buf, 4, L"abc", 1);
    mtest_long_eq(hr, S_OK);
    mtest_pwsz_eq(buf, L"a");

    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNW(buf, 0, L"", 2);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_pwsz_eq(buf, L"");
    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNW(buf, 1, L"", 2);
    mtest_long_eq(hr, S_OK);
    mtest_pwsz_eq(buf, L"");
    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNW(buf, 2, L"", 2);
    mtest_long_eq(hr, S_OK);
    mtest_pwsz_eq(buf, L"");
    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNW(buf, 3, L"", 2);
    mtest_long_eq(hr, S_OK);
    mtest_pwsz_eq(buf, L"");
    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNW(buf, 4, L"", 2);
    mtest_long_eq(hr, S_OK);
    mtest_pwsz_eq(buf, L"");

    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNW(buf, 0, L"a", 2);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_pwsz_eq(buf, L"");
    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNW(buf, 1, L"a", 2);
    mtest_long_eq(hr, STRSAFE_E_INSUFFICIENT_BUFFER);
    mtest_pwsz_eq(buf, L"");
    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNW(buf, 2, L"a", 2);
    mtest_long_eq(hr, S_OK);
    mtest_pwsz_eq(buf, L"a");
    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNW(buf, 3, L"a", 2);
    mtest_long_eq(hr, S_OK);
    mtest_pwsz_eq(buf, L"a");
    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNW(buf, 4, L"a", 2);
    mtest_long_eq(hr, S_OK);
    mtest_pwsz_eq(buf, L"a");

    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNW(buf, 0, L"ab", 2);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_pwsz_eq(buf, L"");
    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNW(buf, 1, L"ab", 2);
    mtest_long_eq(hr, STRSAFE_E_INSUFFICIENT_BUFFER);
    mtest_pwsz_eq(buf, L"");
    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNW(buf, 2, L"ab", 2);
    mtest_long_eq(hr, STRSAFE_E_INSUFFICIENT_BUFFER);
    mtest_pwsz_eq(buf, L"a");
    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNW(buf, 3, L"ab", 2);
    mtest_long_eq(hr, S_OK);
    mtest_pwsz_eq(buf, L"ab");
    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNW(buf, 4, L"ab", 2);
    mtest_long_eq(hr, S_OK);
    mtest_pwsz_eq(buf, L"ab");

    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNW(buf, 0, L"abc", 2);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_pwsz_eq(buf, L"");
    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNW(buf, 1, L"abc", 2);
    mtest_long_eq(hr, STRSAFE_E_INSUFFICIENT_BUFFER);
    mtest_pwsz_eq(buf, L"");
    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNW(buf, 2, L"abc", 2);
    mtest_long_eq(hr, STRSAFE_E_INSUFFICIENT_BUFFER);
    mtest_pwsz_eq(buf, L"a");
    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNW(buf, 3, L"abc", 2);
    mtest_long_eq(hr, S_OK);
    mtest_pwsz_eq(buf, L"ab");
    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNW(buf, 4, L"abc", 2);
    mtest_long_eq(hr, S_OK);
    mtest_pwsz_eq(buf, L"ab");

    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNW(buf, 0, L"", 3);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_pwsz_eq(buf, L"");
    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNW(buf, 1, L"", 3);
    mtest_long_eq(hr, S_OK);
    mtest_pwsz_eq(buf, L"");
    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNW(buf, 2, L"", 3);
    mtest_long_eq(hr, S_OK);
    mtest_pwsz_eq(buf, L"");
    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNW(buf, 3, L"", 3);
    mtest_long_eq(hr, S_OK);
    mtest_pwsz_eq(buf, L"");
    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNW(buf, 4, L"", 3);
    mtest_long_eq(hr, S_OK);
    mtest_pwsz_eq(buf, L"");

    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNW(buf, 0, L"a", 3);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_pwsz_eq(buf, L"");
    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNW(buf, 1, L"a", 3);
    mtest_long_eq(hr, STRSAFE_E_INSUFFICIENT_BUFFER);
    mtest_pwsz_eq(buf, L"");
    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNW(buf, 2, L"a", 3);
    mtest_long_eq(hr, S_OK);
    mtest_pwsz_eq(buf, L"a");
    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNW(buf, 3, L"a", 3);
    mtest_long_eq(hr, S_OK);
    mtest_pwsz_eq(buf, L"a");
    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNW(buf, 4, L"a", 3);
    mtest_long_eq(hr, S_OK);
    mtest_pwsz_eq(buf, L"a");

    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNW(buf, 0, L"ab", 3);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_pwsz_eq(buf, L"");
    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNW(buf, 1, L"ab", 3);
    mtest_long_eq(hr, STRSAFE_E_INSUFFICIENT_BUFFER);
    mtest_pwsz_eq(buf, L"");
    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNW(buf, 2, L"ab", 3);
    mtest_long_eq(hr, STRSAFE_E_INSUFFICIENT_BUFFER);
    mtest_pwsz_eq(buf, L"a");
    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNW(buf, 3, L"ab", 3);
    mtest_long_eq(hr, S_OK);
    mtest_pwsz_eq(buf, L"ab");
    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNW(buf, 4, L"ab", 3);
    mtest_long_eq(hr, S_OK);
    mtest_pwsz_eq(buf, L"ab");

    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNW(buf, 0, L"abc", 3);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_pwsz_eq(buf, L"");
    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNW(buf, 1, L"abc", 3);
    mtest_long_eq(hr, STRSAFE_E_INSUFFICIENT_BUFFER);
    mtest_pwsz_eq(buf, L"");
    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNW(buf, 2, L"abc", 3);
    mtest_long_eq(hr, STRSAFE_E_INSUFFICIENT_BUFFER);
    mtest_pwsz_eq(buf, L"a");
    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNW(buf, 3, L"abc", 3);
    mtest_long_eq(hr, STRSAFE_E_INSUFFICIENT_BUFFER);
    mtest_pwsz_eq(buf, L"ab");
    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNW(buf, 4, L"abc", 3);
    mtest_long_eq(hr, S_OK);
    mtest_pwsz_eq(buf, L"abc");

    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNW(buf, 0, L"", 4);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_pwsz_eq(buf, L"");
    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNW(buf, 1, L"", 4);
    mtest_long_eq(hr, S_OK);
    mtest_pwsz_eq(buf, L"");
    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNW(buf, 2, L"", 4);
    mtest_long_eq(hr, S_OK);
    mtest_pwsz_eq(buf, L"");
    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNW(buf, 3, L"", 4);
    mtest_long_eq(hr, S_OK);
    mtest_pwsz_eq(buf, L"");
    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNW(buf, 4, L"", 4);
    mtest_long_eq(hr, S_OK);
    mtest_pwsz_eq(buf, L"");

    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNW(buf, 0, L"a", 4);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_pwsz_eq(buf, L"");
    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNW(buf, 1, L"a", 4);
    mtest_long_eq(hr, STRSAFE_E_INSUFFICIENT_BUFFER);
    mtest_pwsz_eq(buf, L"");
    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNW(buf, 2, L"a", 4);
    mtest_long_eq(hr, S_OK);
    mtest_pwsz_eq(buf, L"a");
    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNW(buf, 3, L"a", 4);
    mtest_long_eq(hr, S_OK);
    mtest_pwsz_eq(buf, L"a");
    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNW(buf, 4, L"a", 4);
    mtest_long_eq(hr, S_OK);
    mtest_pwsz_eq(buf, L"a");

    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNW(buf, 0, L"ab", 4);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_pwsz_eq(buf, L"");
    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNW(buf, 1, L"ab", 4);
    mtest_long_eq(hr, STRSAFE_E_INSUFFICIENT_BUFFER);
    mtest_pwsz_eq(buf, L"");
    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNW(buf, 2, L"ab", 4);
    mtest_long_eq(hr, STRSAFE_E_INSUFFICIENT_BUFFER);
    mtest_pwsz_eq(buf, L"a");
    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNW(buf, 3, L"ab", 4);
    mtest_long_eq(hr, S_OK);
    mtest_pwsz_eq(buf, L"ab");
    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNW(buf, 4, L"ab", 4);
    mtest_long_eq(hr, S_OK);
    mtest_pwsz_eq(buf, L"ab");

    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNW(buf, 0, L"abc", 4);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_pwsz_eq(buf, L"");
    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNW(buf, 1, L"abc", 4);
    mtest_long_eq(hr, STRSAFE_E_INSUFFICIENT_BUFFER);
    mtest_pwsz_eq(buf, L"");
    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNW(buf, 2, L"abc", 4);
    mtest_long_eq(hr, STRSAFE_E_INSUFFICIENT_BUFFER);
    mtest_pwsz_eq(buf, L"a");
    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNW(buf, 3, L"abc", 4);
    mtest_long_eq(hr, STRSAFE_E_INSUFFICIENT_BUFFER);
    mtest_pwsz_eq(buf, L"ab");
    FILL_BUFFER(buf);
    SET_FIRST(buf);
    hr = StringCchCatNW(buf, 4, L"abc", 4);
    mtest_long_eq(hr, S_OK);
    mtest_pwsz_eq(buf, L"abc");

    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatNW(buf, 0, L"", 0);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_pwsz_eq(buf, L"FFFF");
    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatNW(buf, 1, L"", 0);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_pwsz_eq(buf, L"FFFF");
    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatNW(buf, 2, L"", 0);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_pwsz_eq(buf, L"FFFF");
    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatNW(buf, 3, L"", 0);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_pwsz_eq(buf, L"FFFF");
    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatNW(buf, 4, L"", 0);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_pwsz_eq(buf, L"FFFF");

    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatNW(buf, 0, L"a", 0);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_pwsz_eq(buf, L"FFFF");
    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatNW(buf, 1, L"a", 0);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_pwsz_eq(buf, L"FFFF");
    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatNW(buf, 2, L"a", 0);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_pwsz_eq(buf, L"FFFF");
    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatNW(buf, 3, L"a", 0);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_pwsz_eq(buf, L"FFFF");
    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatNW(buf, 4, L"a", 0);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_pwsz_eq(buf, L"FFFF");

    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatNW(buf, 0, L"ab", 0);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_pwsz_eq(buf, L"FFFF");
    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatNW(buf, 1, L"ab", 0);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_pwsz_eq(buf, L"FFFF");
    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatNW(buf, 2, L"ab", 0);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_pwsz_eq(buf, L"FFFF");
    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatNW(buf, 3, L"ab", 0);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_pwsz_eq(buf, L"FFFF");
    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatNW(buf, 4, L"ab", 0);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_pwsz_eq(buf, L"FFFF");

    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatNW(buf, 0, L"abc", 0);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_pwsz_eq(buf, L"FFFF");
    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatNW(buf, 1, L"abc", 0);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_pwsz_eq(buf, L"FFFF");
    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatNW(buf, 2, L"abc", 0);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_pwsz_eq(buf, L"FFFF");
    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatNW(buf, 3, L"abc", 0);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_pwsz_eq(buf, L"FFFF");
    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatNW(buf, 4, L"abc", 0);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_pwsz_eq(buf, L"FFFF");

    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatNW(buf, 0, L"", 1);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_pwsz_eq(buf, L"FFFF");
    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatNW(buf, 1, L"", 1);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_pwsz_eq(buf, L"FFFF");
    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatNW(buf, 2, L"", 1);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_pwsz_eq(buf, L"FFFF");
    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatNW(buf, 3, L"", 1);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_pwsz_eq(buf, L"FFFF");
    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatNW(buf, 4, L"", 1);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_pwsz_eq(buf, L"FFFF");

    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatNW(buf, 0, L"a", 1);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_pwsz_eq(buf, L"FFFF");
    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatNW(buf, 1, L"a", 1);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_pwsz_eq(buf, L"FFFF");
    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatNW(buf, 2, L"a", 1);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_pwsz_eq(buf, L"FFFF");
    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatNW(buf, 3, L"a", 1);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_pwsz_eq(buf, L"FFFF");
    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatNW(buf, 4, L"a", 1);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_pwsz_eq(buf, L"FFFF");

    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatNW(buf, 0, L"ab", 1);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_pwsz_eq(buf, L"FFFF");
    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatNW(buf, 1, L"ab", 1);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_pwsz_eq(buf, L"FFFF");
    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatNW(buf, 2, L"ab", 1);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_pwsz_eq(buf, L"FFFF");
    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatNW(buf, 3, L"ab", 1);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_pwsz_eq(buf, L"FFFF");
    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatNW(buf, 4, L"ab", 1);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_pwsz_eq(buf, L"FFFF");

    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatNW(buf, 0, L"abc", 1);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_pwsz_eq(buf, L"FFFF");
    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatNW(buf, 1, L"abc", 1);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_pwsz_eq(buf, L"FFFF");
    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatNW(buf, 2, L"abc", 1);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_pwsz_eq(buf, L"FFFF");
    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatNW(buf, 3, L"abc", 1);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_pwsz_eq(buf, L"FFFF");
    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatNW(buf, 4, L"abc", 1);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_pwsz_eq(buf, L"FFFF");

    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatNW(buf, 0, L"", 2);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_pwsz_eq(buf, L"FFFF");
    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatNW(buf, 1, L"", 2);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_pwsz_eq(buf, L"FFFF");
    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatNW(buf, 2, L"", 2);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_pwsz_eq(buf, L"FFFF");
    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatNW(buf, 3, L"", 2);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_pwsz_eq(buf, L"FFFF");
    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatNW(buf, 4, L"", 2);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_pwsz_eq(buf, L"FFFF");

    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatNW(buf, 0, L"a", 2);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_pwsz_eq(buf, L"FFFF");
    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatNW(buf, 1, L"a", 2);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_pwsz_eq(buf, L"FFFF");
    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatNW(buf, 2, L"a", 2);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_pwsz_eq(buf, L"FFFF");
    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatNW(buf, 3, L"a", 2);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_pwsz_eq(buf, L"FFFF");
    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatNW(buf, 4, L"a", 2);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_pwsz_eq(buf, L"FFFF");

    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatNW(buf, 0, L"ab", 2);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_pwsz_eq(buf, L"FFFF");
    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatNW(buf, 1, L"ab", 2);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_pwsz_eq(buf, L"FFFF");
    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatNW(buf, 2, L"ab", 2);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_pwsz_eq(buf, L"FFFF");
    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatNW(buf, 3, L"ab", 2);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_pwsz_eq(buf, L"FFFF");
    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatNW(buf, 4, L"ab", 2);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_pwsz_eq(buf, L"FFFF");

    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatNW(buf, 0, L"abc", 2);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_pwsz_eq(buf, L"FFFF");
    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatNW(buf, 1, L"abc", 2);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_pwsz_eq(buf, L"FFFF");
    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatNW(buf, 2, L"abc", 2);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_pwsz_eq(buf, L"FFFF");
    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatNW(buf, 3, L"abc", 2);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_pwsz_eq(buf, L"FFFF");
    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatNW(buf, 4, L"abc", 2);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_pwsz_eq(buf, L"FFFF");

    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatNW(buf, 0, L"", 3);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_pwsz_eq(buf, L"FFFF");
    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatNW(buf, 1, L"", 3);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_pwsz_eq(buf, L"FFFF");
    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatNW(buf, 2, L"", 3);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_pwsz_eq(buf, L"FFFF");
    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatNW(buf, 3, L"", 3);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_pwsz_eq(buf, L"FFFF");
    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatNW(buf, 4, L"", 3);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_pwsz_eq(buf, L"FFFF");

    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatNW(buf, 0, L"a", 3);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_pwsz_eq(buf, L"FFFF");
    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatNW(buf, 1, L"a", 3);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_pwsz_eq(buf, L"FFFF");
    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatNW(buf, 2, L"a", 3);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_pwsz_eq(buf, L"FFFF");
    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatNW(buf, 3, L"a", 3);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_pwsz_eq(buf, L"FFFF");
    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatNW(buf, 4, L"a", 3);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_pwsz_eq(buf, L"FFFF");

    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatNW(buf, 0, L"ab", 3);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_pwsz_eq(buf, L"FFFF");
    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatNW(buf, 1, L"ab", 3);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_pwsz_eq(buf, L"FFFF");
    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatNW(buf, 2, L"ab", 3);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_pwsz_eq(buf, L"FFFF");
    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatNW(buf, 3, L"ab", 3);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_pwsz_eq(buf, L"FFFF");
    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatNW(buf, 4, L"ab", 3);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_pwsz_eq(buf, L"FFFF");

    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatNW(buf, 0, L"abc", 3);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_pwsz_eq(buf, L"FFFF");
    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatNW(buf, 1, L"abc", 3);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_pwsz_eq(buf, L"FFFF");
    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatNW(buf, 2, L"abc", 3);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_pwsz_eq(buf, L"FFFF");
    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatNW(buf, 3, L"abc", 3);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_pwsz_eq(buf, L"FFFF");
    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatNW(buf, 4, L"abc", 3);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_pwsz_eq(buf, L"FFFF");

    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatNW(buf, 0, L"", 4);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_pwsz_eq(buf, L"FFFF");
    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatNW(buf, 1, L"", 4);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_pwsz_eq(buf, L"FFFF");
    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatNW(buf, 2, L"", 4);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_pwsz_eq(buf, L"FFFF");
    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatNW(buf, 3, L"", 4);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_pwsz_eq(buf, L"FFFF");
    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatNW(buf, 4, L"", 4);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_pwsz_eq(buf, L"FFFF");

    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatNW(buf, 0, L"a", 4);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_pwsz_eq(buf, L"FFFF");
    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatNW(buf, 1, L"a", 4);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_pwsz_eq(buf, L"FFFF");
    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatNW(buf, 2, L"a", 4);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_pwsz_eq(buf, L"FFFF");
    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatNW(buf, 3, L"a", 4);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_pwsz_eq(buf, L"FFFF");
    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatNW(buf, 4, L"a", 4);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_pwsz_eq(buf, L"FFFF");

    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatNW(buf, 0, L"ab", 4);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_pwsz_eq(buf, L"FFFF");
    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatNW(buf, 1, L"ab", 4);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_pwsz_eq(buf, L"FFFF");
    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatNW(buf, 2, L"ab", 4);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_pwsz_eq(buf, L"FFFF");
    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatNW(buf, 3, L"ab", 4);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_pwsz_eq(buf, L"FFFF");
    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatNW(buf, 4, L"ab", 4);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_pwsz_eq(buf, L"FFFF");

    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatNW(buf, 0, L"abc", 4);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_pwsz_eq(buf, L"FFFF");
    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatNW(buf, 1, L"abc", 4);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_pwsz_eq(buf, L"FFFF");
    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatNW(buf, 2, L"abc", 4);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_pwsz_eq(buf, L"FFFF");
    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatNW(buf, 3, L"abc", 4);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_pwsz_eq(buf, L"FFFF");
    FILL_BUFFER(buf);
    SET_MIDDLE(buf);
    hr = StringCchCatNW(buf, 4, L"abc", 4);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_pwsz_eq(buf, L"FFFF");
}

START_TEST(StringCchCopyNW)
{
    wchar_t buf[BUFSIZE];
    HRESULT hr;

    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNW(buf, INVALID_LENGTH, L"a", 0);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    //mtest_pwsz_eq(buf, L"FFFFFFF"); // can be ''

    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNW(buf, 0, L"a", INVALID_LENGTH);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_pwsz_eq(buf, L"FFFFFFF");

    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNW(buf, 0, L"", 0);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_pwsz_eq(buf, L"FFFFFFF");
    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNW(buf, 1, L"", 0);
    mtest_long_eq(hr, S_OK);
    mtest_pwsz_eq(buf, L"");
    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNW(buf, 2, L"", 0);
    mtest_long_eq(hr, S_OK);
    mtest_pwsz_eq(buf, L"");
    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNW(buf, 3, L"", 0);
    mtest_long_eq(hr, S_OK);
    mtest_pwsz_eq(buf, L"");
    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNW(buf, 4, L"", 0);
    mtest_long_eq(hr, S_OK);
    mtest_pwsz_eq(buf, L"");

    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNW(buf, 0, L"a", 0);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_pwsz_eq(buf, L"FFFFFFF");
    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNW(buf, 1, L"a", 0);
    mtest_long_eq(hr, S_OK);
    mtest_pwsz_eq(buf, L"");
    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNW(buf, 2, L"a", 0);
    mtest_long_eq(hr, S_OK);
    mtest_pwsz_eq(buf, L"");
    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNW(buf, 3, L"a", 0);
    mtest_long_eq(hr, S_OK);
    mtest_pwsz_eq(buf, L"");
    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNW(buf, 4, L"a", 0);
    mtest_long_eq(hr, S_OK);
    mtest_pwsz_eq(buf, L"");

    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNW(buf, 0, L"ab", 0);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_pwsz_eq(buf, L"FFFFFFF");
    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNW(buf, 1, L"ab", 0);
    mtest_long_eq(hr, S_OK);
    mtest_pwsz_eq(buf, L"");
    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNW(buf, 2, L"ab", 0);
    mtest_long_eq(hr, S_OK);
    mtest_pwsz_eq(buf, L"");
    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNW(buf, 3, L"ab", 0);
    mtest_long_eq(hr, S_OK);
    mtest_pwsz_eq(buf, L"");
    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNW(buf, 4, L"ab", 0);
    mtest_long_eq(hr, S_OK);
    mtest_pwsz_eq(buf, L"");

    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNW(buf, 0, L"abc", 0);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_pwsz_eq(buf, L"FFFFFFF");
    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNW(buf, 1, L"abc", 0);
    mtest_long_eq(hr, S_OK);
    mtest_pwsz_eq(buf, L"");
    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNW(buf, 2, L"abc", 0);
    mtest_long_eq(hr, S_OK);
    mtest_pwsz_eq(buf, L"");
    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNW(buf, 3, L"abc", 0);
    mtest_long_eq(hr, S_OK);
    mtest_pwsz_eq(buf, L"");
    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNW(buf, 4, L"abc", 0);
    mtest_long_eq(hr, S_OK);
    mtest_pwsz_eq(buf, L"");

    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNW(buf, 0, L"", 1);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_pwsz_eq(buf, L"FFFFFFF");
    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNW(buf, 1, L"", 1);
    mtest_long_eq(hr, S_OK);
    mtest_pwsz_eq(buf, L"");
    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNW(buf, 2, L"", 1);
    mtest_long_eq(hr, S_OK);
    mtest_pwsz_eq(buf, L"");
    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNW(buf, 3, L"", 1);
    mtest_long_eq(hr, S_OK);
    mtest_pwsz_eq(buf, L"");
    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNW(buf, 4, L"", 1);
    mtest_long_eq(hr, S_OK);
    mtest_pwsz_eq(buf, L"");

    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNW(buf, 0, L"a", 1);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_pwsz_eq(buf, L"FFFFFFF");
    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNW(buf, 1, L"a", 1);
    mtest_long_eq(hr, STRSAFE_E_INSUFFICIENT_BUFFER);
    mtest_pwsz_eq(buf, L"");
    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNW(buf, 2, L"a", 1);
    mtest_long_eq(hr, S_OK);
    mtest_pwsz_eq(buf, L"a");
    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNW(buf, 3, L"a", 1);
    mtest_long_eq(hr, S_OK);
    mtest_pwsz_eq(buf, L"a");
    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNW(buf, 4, L"a", 1);
    mtest_long_eq(hr, S_OK);
    mtest_pwsz_eq(buf, L"a");

    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNW(buf, 0, L"ab", 1);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_pwsz_eq(buf, L"FFFFFFF");
    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNW(buf, 1, L"ab", 1);
    mtest_long_eq(hr, STRSAFE_E_INSUFFICIENT_BUFFER);
    mtest_pwsz_eq(buf, L"");
    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNW(buf, 2, L"ab", 1);
    mtest_long_eq(hr, S_OK);
    mtest_pwsz_eq(buf, L"a");
    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNW(buf, 3, L"ab", 1);
    mtest_long_eq(hr, S_OK);
    mtest_pwsz_eq(buf, L"a");
    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNW(buf, 4, L"ab", 1);
    mtest_long_eq(hr, S_OK);
    mtest_pwsz_eq(buf, L"a");

    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNW(buf, 0, L"abc", 1);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_pwsz_eq(buf, L"FFFFFFF");
    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNW(buf, 1, L"abc", 1);
    mtest_long_eq(hr, STRSAFE_E_INSUFFICIENT_BUFFER);
    mtest_pwsz_eq(buf, L"");
    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNW(buf, 2, L"abc", 1);
    mtest_long_eq(hr, S_OK);
    mtest_pwsz_eq(buf, L"a");
    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNW(buf, 3, L"abc", 1);
    mtest_long_eq(hr, S_OK);
    mtest_pwsz_eq(buf, L"a");
    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNW(buf, 4, L"abc", 1);
    mtest_long_eq(hr, S_OK);
    mtest_pwsz_eq(buf, L"a");

    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNW(buf, 0, L"", 2);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_pwsz_eq(buf, L"FFFFFFF");
    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNW(buf, 1, L"", 2);
    mtest_long_eq(hr, S_OK);
    mtest_pwsz_eq(buf, L"");
    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNW(buf, 2, L"", 2);
    mtest_long_eq(hr, S_OK);
    mtest_pwsz_eq(buf, L"");
    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNW(buf, 3, L"", 2);
    mtest_long_eq(hr, S_OK);
    mtest_pwsz_eq(buf, L"");
    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNW(buf, 4, L"", 2);
    mtest_long_eq(hr, S_OK);
    mtest_pwsz_eq(buf, L"");

    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNW(buf, 0, L"a", 2);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_pwsz_eq(buf, L"FFFFFFF");
    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNW(buf, 1, L"a", 2);
    mtest_long_eq(hr, STRSAFE_E_INSUFFICIENT_BUFFER);
    mtest_pwsz_eq(buf, L"");
    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNW(buf, 2, L"a", 2);
    mtest_long_eq(hr, S_OK);
    mtest_pwsz_eq(buf, L"a");
    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNW(buf, 3, L"a", 2);
    mtest_long_eq(hr, S_OK);
    mtest_pwsz_eq(buf, L"a");
    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNW(buf, 4, L"a", 2);
    mtest_long_eq(hr, S_OK);
    mtest_pwsz_eq(buf, L"a");

    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNW(buf, 0, L"ab", 2);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_pwsz_eq(buf, L"FFFFFFF");
    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNW(buf, 1, L"ab", 2);
    mtest_long_eq(hr, STRSAFE_E_INSUFFICIENT_BUFFER);
    mtest_pwsz_eq(buf, L"");
    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNW(buf, 2, L"ab", 2);
    mtest_long_eq(hr, STRSAFE_E_INSUFFICIENT_BUFFER);
    mtest_pwsz_eq(buf, L"a");
    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNW(buf, 3, L"ab", 2);
    mtest_long_eq(hr, S_OK);
    mtest_pwsz_eq(buf, L"ab");
    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNW(buf, 4, L"ab", 2);
    mtest_long_eq(hr, S_OK);
    mtest_pwsz_eq(buf, L"ab");

    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNW(buf, 0, L"abc", 2);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_pwsz_eq(buf, L"FFFFFFF");
    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNW(buf, 1, L"abc", 2);
    mtest_long_eq(hr, STRSAFE_E_INSUFFICIENT_BUFFER);
    mtest_pwsz_eq(buf, L"");
    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNW(buf, 2, L"abc", 2);
    mtest_long_eq(hr, STRSAFE_E_INSUFFICIENT_BUFFER);
    mtest_pwsz_eq(buf, L"a");
    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNW(buf, 3, L"abc", 2);
    mtest_long_eq(hr, S_OK);
    mtest_pwsz_eq(buf, L"ab");
    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNW(buf, 4, L"abc", 2);
    mtest_long_eq(hr, S_OK);
    mtest_pwsz_eq(buf, L"ab");

    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNW(buf, 0, L"", 3);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_pwsz_eq(buf, L"FFFFFFF");
    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNW(buf, 1, L"", 3);
    mtest_long_eq(hr, S_OK);
    mtest_pwsz_eq(buf, L"");
    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNW(buf, 2, L"", 3);
    mtest_long_eq(hr, S_OK);
    mtest_pwsz_eq(buf, L"");
    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNW(buf, 3, L"", 3);
    mtest_long_eq(hr, S_OK);
    mtest_pwsz_eq(buf, L"");
    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNW(buf, 4, L"", 3);
    mtest_long_eq(hr, S_OK);
    mtest_pwsz_eq(buf, L"");

    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNW(buf, 0, L"a", 3);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_pwsz_eq(buf, L"FFFFFFF");
    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNW(buf, 1, L"a", 3);
    mtest_long_eq(hr, STRSAFE_E_INSUFFICIENT_BUFFER);
    mtest_pwsz_eq(buf, L"");
    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNW(buf, 2, L"a", 3);
    mtest_long_eq(hr, S_OK);
    mtest_pwsz_eq(buf, L"a");
    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNW(buf, 3, L"a", 3);
    mtest_long_eq(hr, S_OK);
    mtest_pwsz_eq(buf, L"a");
    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNW(buf, 4, L"a", 3);
    mtest_long_eq(hr, S_OK);
    mtest_pwsz_eq(buf, L"a");

    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNW(buf, 0, L"ab", 3);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_pwsz_eq(buf, L"FFFFFFF");
    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNW(buf, 1, L"ab", 3);
    mtest_long_eq(hr, STRSAFE_E_INSUFFICIENT_BUFFER);
    mtest_pwsz_eq(buf, L"");
    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNW(buf, 2, L"ab", 3);
    mtest_long_eq(hr, STRSAFE_E_INSUFFICIENT_BUFFER);
    mtest_pwsz_eq(buf, L"a");
    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNW(buf, 3, L"ab", 3);
    mtest_long_eq(hr, S_OK);
    mtest_pwsz_eq(buf, L"ab");
    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNW(buf, 4, L"ab", 3);
    mtest_long_eq(hr, S_OK);
    mtest_pwsz_eq(buf, L"ab");

    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNW(buf, 0, L"abc", 3);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_pwsz_eq(buf, L"FFFFFFF");
    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNW(buf, 1, L"abc", 3);
    mtest_long_eq(hr, STRSAFE_E_INSUFFICIENT_BUFFER);
    mtest_pwsz_eq(buf, L"");
    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNW(buf, 2, L"abc", 3);
    mtest_long_eq(hr, STRSAFE_E_INSUFFICIENT_BUFFER);
    mtest_pwsz_eq(buf, L"a");
    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNW(buf, 3, L"abc", 3);
    mtest_long_eq(hr, STRSAFE_E_INSUFFICIENT_BUFFER);
    mtest_pwsz_eq(buf, L"ab");
    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNW(buf, 4, L"abc", 3);
    mtest_long_eq(hr, S_OK);
    mtest_pwsz_eq(buf, L"abc");

    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNW(buf, 0, L"", 4);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_pwsz_eq(buf, L"FFFFFFF");
    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNW(buf, 1, L"", 4);
    mtest_long_eq(hr, S_OK);
    mtest_pwsz_eq(buf, L"");
    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNW(buf, 2, L"", 4);
    mtest_long_eq(hr, S_OK);
    mtest_pwsz_eq(buf, L"");
    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNW(buf, 3, L"", 4);
    mtest_long_eq(hr, S_OK);
    mtest_pwsz_eq(buf, L"");
    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNW(buf, 4, L"", 4);
    mtest_long_eq(hr, S_OK);
    mtest_pwsz_eq(buf, L"");

    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNW(buf, 0, L"a", 4);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_pwsz_eq(buf, L"FFFFFFF");
    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNW(buf, 1, L"a", 4);
    mtest_long_eq(hr, STRSAFE_E_INSUFFICIENT_BUFFER);
    mtest_pwsz_eq(buf, L"");
    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNW(buf, 2, L"a", 4);
    mtest_long_eq(hr, S_OK);
    mtest_pwsz_eq(buf, L"a");
    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNW(buf, 3, L"a", 4);
    mtest_long_eq(hr, S_OK);
    mtest_pwsz_eq(buf, L"a");
    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNW(buf, 4, L"a", 4);
    mtest_long_eq(hr, S_OK);
    mtest_pwsz_eq(buf, L"a");

    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNW(buf, 0, L"ab", 4);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_pwsz_eq(buf, L"FFFFFFF");
    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNW(buf, 1, L"ab", 4);
    mtest_long_eq(hr, STRSAFE_E_INSUFFICIENT_BUFFER);
    mtest_pwsz_eq(buf, L"");
    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNW(buf, 2, L"ab", 4);
    mtest_long_eq(hr, STRSAFE_E_INSUFFICIENT_BUFFER);
    mtest_pwsz_eq(buf, L"a");
    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNW(buf, 3, L"ab", 4);
    mtest_long_eq(hr, S_OK);
    mtest_pwsz_eq(buf, L"ab");
    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNW(buf, 4, L"ab", 4);
    mtest_long_eq(hr, S_OK);
    mtest_pwsz_eq(buf, L"ab");

    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNW(buf, 0, L"abc", 4);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_pwsz_eq(buf, L"FFFFFFF");
    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNW(buf, 1, L"abc", 4);
    mtest_long_eq(hr, STRSAFE_E_INSUFFICIENT_BUFFER);
    mtest_pwsz_eq(buf, L"");
    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNW(buf, 2, L"abc", 4);
    mtest_long_eq(hr, STRSAFE_E_INSUFFICIENT_BUFFER);
    mtest_pwsz_eq(buf, L"a");
    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNW(buf, 3, L"abc", 4);
    mtest_long_eq(hr, STRSAFE_E_INSUFFICIENT_BUFFER);
    mtest_pwsz_eq(buf, L"ab");
    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchCopyNW(buf, 4, L"abc", 4);
    mtest_long_eq(hr, S_OK);
    mtest_pwsz_eq(buf, L"abc");
}

START_TEST(StringCchPrintfW)
{
    wchar_t buf[BUFSIZE];
    HRESULT hr;

    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchPrintfW(buf, INVALID_LENGTH, L"%d", 1234);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    //mtest_pwsz_eq(buf, L"FFFFFFF"); // can be ''

    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchPrintfW(buf, 0, L"%d", 1234);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_pwsz_eq(buf, L"FFFFFFF");

    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchPrintfW(buf, 1, L"%d", 1234);
    mtest_long_eq(hr, STRSAFE_E_INSUFFICIENT_BUFFER);
    mtest_pwsz_eq(buf, L"");

    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchPrintfW(buf, 2, L"%d", 1234);
    mtest_long_eq(hr, STRSAFE_E_INSUFFICIENT_BUFFER);
    mtest_pwsz_eq(buf, L"1");

    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchPrintfW(buf, 3, L"%d", 1234);
    mtest_long_eq(hr, STRSAFE_E_INSUFFICIENT_BUFFER);
    mtest_pwsz_eq(buf, L"12");

    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchPrintfW(buf, 4, L"%d", 1234);
    mtest_long_eq(hr, STRSAFE_E_INSUFFICIENT_BUFFER);
    mtest_pwsz_eq(buf, L"123");

    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchPrintfW(buf, 5, L"%d", 1234);
    mtest_long_eq(hr, S_OK);
    mtest_pwsz_eq(buf, L"1234");

    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchPrintfW(buf, 0, L"%s", L"1234");
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_pwsz_eq(buf, L"FFFFFFF");

    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchPrintfW(buf, 1, L"%s", L"1234");
    mtest_long_eq(hr, STRSAFE_E_INSUFFICIENT_BUFFER);
    mtest_pwsz_eq(buf, L"");

    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchPrintfW(buf, 2, L"%s", L"1234");
    mtest_long_eq(hr, STRSAFE_E_INSUFFICIENT_BUFFER);
    mtest_pwsz_eq(buf, L"1");

    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchPrintfW(buf, 3, L"%s", L"1234");
    mtest_long_eq(hr, STRSAFE_E_INSUFFICIENT_BUFFER);
    mtest_pwsz_eq(buf, L"12");

    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchPrintfW(buf, 4, L"%s", L"1234");
    mtest_long_eq(hr, STRSAFE_E_INSUFFICIENT_BUFFER);
    mtest_pwsz_eq(buf, L"123");

    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = StringCchPrintfW(buf, 5, L"%s", L"1234");
    mtest_long_eq(hr, S_OK);
    mtest_pwsz_eq(buf, L"1234");
}

static HRESULT
vprintf_test_helperW(
    wchar_t *pszDest,
    size_t cchDest,
    const wchar_t *pszFormat,
    ...)
{
    va_list va;
    HRESULT hr;
    va_start(va, pszFormat);
    hr = StringCchVPrintfW(pszDest, cchDest, pszFormat, va);
    va_end(va);
    return hr;
}

START_TEST(StringCchVPrintfW)
{
    wchar_t buf[BUFSIZE];
    HRESULT hr;

    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = vprintf_test_helperW(buf, INVALID_LENGTH, L"%d", 1234);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    //mtest_pwsz_eq(buf, L"FFFFFFF"); // can be ''

    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = vprintf_test_helperW(buf, 0, L"%d", 1234);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_pwsz_eq(buf, L"FFFFFFF");

    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = vprintf_test_helperW(buf, 1, L"%d", 1234);
    mtest_long_eq(hr, STRSAFE_E_INSUFFICIENT_BUFFER);
    mtest_pwsz_eq(buf, L"");

    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = vprintf_test_helperW(buf, 2, L"%d", 1234);
    mtest_long_eq(hr, STRSAFE_E_INSUFFICIENT_BUFFER);
    mtest_pwsz_eq(buf, L"1");

    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = vprintf_test_helperW(buf, 3, L"%d", 1234);
    mtest_long_eq(hr, STRSAFE_E_INSUFFICIENT_BUFFER);
    mtest_pwsz_eq(buf, L"12");

    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = vprintf_test_helperW(buf, 4, L"%d", 1234);
    mtest_long_eq(hr, STRSAFE_E_INSUFFICIENT_BUFFER);
    mtest_pwsz_eq(buf, L"123");

    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = vprintf_test_helperW(buf, 5, L"%d", 1234);
    mtest_long_eq(hr, S_OK);
    mtest_pwsz_eq(buf, L"1234");

    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = vprintf_test_helperW(buf, 0, L"%s", L"1234");
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest_pwsz_eq(buf, L"FFFFFFF");

    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = vprintf_test_helperW(buf, 1, L"%s", L"1234");
    mtest_long_eq(hr, STRSAFE_E_INSUFFICIENT_BUFFER);
    mtest_pwsz_eq(buf, L"");

    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = vprintf_test_helperW(buf, 2, L"%s", L"1234");
    mtest_long_eq(hr, STRSAFE_E_INSUFFICIENT_BUFFER);
    mtest_pwsz_eq(buf, L"1");

    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = vprintf_test_helperW(buf, 3, L"%s", L"1234");
    mtest_long_eq(hr, STRSAFE_E_INSUFFICIENT_BUFFER);
    mtest_pwsz_eq(buf, L"12");

    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = vprintf_test_helperW(buf, 4, L"%s", L"1234");
    mtest_long_eq(hr, STRSAFE_E_INSUFFICIENT_BUFFER);
    mtest_pwsz_eq(buf, L"123");

    FILL_BUFFER(buf);
    SET_LAST(buf);
    hr = vprintf_test_helperW(buf, 5, L"%s", L"1234");
    mtest_long_eq(hr, S_OK);
    mtest_pwsz_eq(buf, L"1234");
}


START_TEST(StringCchLengthW)
{
    size_t cch;
    HRESULT hr;

    cch = 123;
    hr = StringCchLengthW(L"a", INVALID_LENGTH, &cch);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest(cch == 0, "%d\n", (int)cch);

    cch = 123;
    hr = StringCchLengthW(L"", 0, &cch);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest(cch == 0, "%d\n", (int)cch);
    cch = 123;
    hr = StringCchLengthW(L"", 1, &cch);
    mtest_long_eq(hr, S_OK);
    mtest(cch == 0, "%d\n", (int)cch);
    cch = 123;
    hr = StringCchLengthW(L"", 2, &cch);
    mtest_long_eq(hr, S_OK);
    mtest(cch == 0, "%d\n", (int)cch);
    cch = 123;
    hr = StringCchLengthW(L"", 3, &cch);
    mtest_long_eq(hr, S_OK);
    mtest(cch == 0, "%d\n", (int)cch);

    cch = 123;
    hr = StringCchLengthW(L"a", 0, &cch);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest(cch == 0, "%d\n", (int)cch);
    cch = 123;
    hr = StringCchLengthW(L"a", 1, &cch);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest(cch == 0, "%d\n", (int)cch);
    cch = 123;
    hr = StringCchLengthW(L"a", 2, &cch);
    mtest_long_eq(hr, S_OK);
    mtest(cch == 1, "%d\n", (int)cch);
    cch = 123;
    hr = StringCchLengthW(L"a", 3, &cch);
    mtest_long_eq(hr, S_OK);
    mtest(cch == 1, "%d\n", (int)cch);

    cch = 123;
    hr = StringCchLengthW(L"ab", 0, &cch);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest(cch == 0, "%d\n", (int)cch);
    cch = 123;
    hr = StringCchLengthW(L"ab", 1, &cch);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest(cch == 0, "%d\n", (int)cch);
    cch = 123;
    hr = StringCchLengthW(L"ab", 2, &cch);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest(cch == 0, "%d\n", (int)cch);
    cch = 123;
    hr = StringCchLengthW(L"ab", 3, &cch);
    mtest_long_eq(hr, S_OK);
    mtest(cch == 2, "%d\n", (int)cch);

    cch = 123;
    hr = StringCchLengthW(L"abc", 0, &cch);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest(cch == 0, "%d\n", (int)cch);
    cch = 123;
    hr = StringCchLengthW(L"abc", 1, &cch);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest(cch == 0, "%d\n", (int)cch);
    cch = 123;
    hr = StringCchLengthW(L"abc", 2, &cch);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest(cch == 0, "%d\n", (int)cch);
    cch = 123;
    hr = StringCchLengthW(L"abc", 3, &cch);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest(cch == 0, "%d\n", (int)cch);

    cch = 123;
    hr = StringCchLengthW(L"abcd", 0, &cch);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest(cch == 0, "%d\n", (int)cch);
    cch = 123;
    hr = StringCchLengthW(L"abcd", 1, &cch);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest(cch == 0, "%d\n", (int)cch);
    cch = 123;
    hr = StringCchLengthW(L"abcd", 2, &cch);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest(cch == 0, "%d\n", (int)cch);
    cch = 123;
    hr = StringCchLengthW(L"abcd", 3, &cch);
    mtest_long_eq(hr, STRSAFE_E_INVALID_PARAMETER);
    mtest(cch == 0, "%d\n", (int)cch);
}
#endif  // def _WIN32

BEGIN_TESTS()
    DEFINE_TEST(StringCchCatA)
    DEFINE_TEST(StringCchCatNA)
    DEFINE_TEST(StringCchCopyA)
    DEFINE_TEST(StringCchCopyNA)
    DEFINE_TEST(StringCchLengthA)
    DEFINE_TEST(StringCchPrintfA)
    DEFINE_TEST(StringCchVPrintfA)
#ifdef _WIN32
    DEFINE_TEST(StringCchCatW)
    DEFINE_TEST(StringCchCatNW)
    DEFINE_TEST(StringCchCopyW)
    DEFINE_TEST(StringCchCopyNW)
    DEFINE_TEST(StringCchLengthW)
    DEFINE_TEST(StringCchPrintfW)
    DEFINE_TEST(StringCchVPrintfW)
#endif
END_TESTS()
